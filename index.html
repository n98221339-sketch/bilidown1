<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BiliDown ‚Äî Bilibili & Douyin</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0a0f;--panel:#111118;--border:#1e1e2e;--ch:#141420;
  --accent:#00e5ff;--a2:#ff3d6b;--a3:#7b61ff;
  --green:#00e676;--warn:#ffb300;--text:#e0e0f0;--muted:#555570;
  --vid-bg:#071820;--vid-c:#00e5ff;
  --aud-bg:#071a0f;--aud-c:#00e676;
  --img-bg:#110d1e;--img-c:#7b61ff;
  --web-bg:#1a1200;--web-c:#ffb300;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);font-family:'Space Mono',monospace;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:linear-gradient(rgba(0,229,255,.03)1px,transparent 1px),linear-gradient(90deg,rgba(0,229,255,.03)1px,transparent 1px);
  background-size:42px 42px}
.w{max-width:1060px;margin:0 auto;padding:0 14px;position:relative;z-index:1}
header{background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:200}
.hi{display:flex;align-items:center;gap:12px;padding:0 14px;height:52px;max-width:1060px;margin:0 auto}
.logo{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),var(--a3));border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0}
.ht{font-size:17px;letter-spacing:2px;color:var(--accent);font-weight:700}
.hs{font-size:9px;color:var(--muted);margin-top:1px;font-family:'Noto Sans SC',sans-serif}
.hb{margin-left:auto;display:flex;gap:6px;align-items:center}
.pt{padding:2px 8px;border-radius:4px;font-size:8px;letter-spacing:1px;border:1px solid}
.pb{color:#00b5e2;border-color:#00b5e2;background:rgba(0,181,226,.08)}
.pd{color:var(--a2);border-color:var(--a2);background:rgba(255,61,107,.08)}
.pm{color:var(--green);border-color:var(--green);background:rgba(0,230,118,.08)}
.tabbar{background:var(--panel);border-bottom:1px solid var(--border)}
.tabs{display:flex;max-width:1060px;margin:0 auto;padding:0 14px}
.tab{padding:11px 18px;font-size:10px;letter-spacing:1px;cursor:pointer;color:var(--muted);
  border-bottom:2px solid transparent;transition:all .18s;background:none;
  border-top:none;border-left:none;border-right:none;font-family:'Space Mono',monospace;white-space:nowrap}
.tab.on{color:var(--accent);border-bottom-color:var(--accent)}
.tab:hover:not(.on){color:var(--text)}
.tb2{background:var(--a3);color:#fff;border-radius:8px;font-size:8px;padding:1px 5px;margin-left:3px}
.pane{display:none;padding:16px 0 50px}.pane.on{display:block}
.card{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:12px}
.cl{font-size:9px;color:var(--muted);letter-spacing:1px;margin-bottom:7px;display:block}
textarea,input[type=text]{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:11px;border-radius:6px;padding:9px 11px;resize:vertical;outline:none;transition:border-color .2s}
textarea{height:100px}
textarea:focus,input:focus{border-color:var(--accent)}
textarea::placeholder{color:var(--muted)}
select{background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:10px;padding:5px 8px;border-radius:4px;outline:none;cursor:pointer}
.ibox{border-radius:8px;padding:10px 14px;font-size:11px;margin-bottom:12px;line-height:1.8;font-family:'Noto Sans SC',sans-serif}
.ibox b,.ibox code{font-family:'Space Mono',monospace}
.ibg{background:rgba(0,230,118,.05);border:1px solid rgba(0,230,118,.2);color:var(--green)}
.opts{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
.og{display:flex;flex-direction:column;gap:3px}
.og label{font-size:9px;color:var(--muted);letter-spacing:1px}
.btn{padding:7px 14px;border-radius:6px;font-family:'Space Mono',monospace;font-size:10px;letter-spacing:.4px;cursor:pointer;border:none;transition:all .14s;display:inline-flex;align-items:center;gap:5px;white-space:nowrap;font-weight:700;text-decoration:none;line-height:1}
.btn:active{transform:scale(.97)}
.btn[disabled]{opacity:.35;cursor:not-allowed;transform:none!important}
.bprim{background:var(--accent);color:var(--bg)}.bprim:hover{background:#33eeff}
.bsec{background:transparent;color:var(--text);border:1px solid var(--border)}.bsec:hover{border-color:var(--text)}
.bdel{background:transparent;color:var(--a2);border:1px solid var(--a2)}.bdel:hover{background:rgba(255,61,107,.08)}
.bvid{background:var(--vid-bg);color:var(--vid-c);border:1.5px solid var(--vid-c);box-shadow:0 0 10px rgba(0,229,255,.1)}.bvid:hover{background:#0d2535;box-shadow:0 0 18px rgba(0,229,255,.25)}
.baud{background:var(--aud-bg);color:var(--aud-c);border:1.5px solid var(--aud-c);box-shadow:0 0 10px rgba(0,230,118,.08)}.baud:hover{background:#0d2c18}
.bimg{background:var(--img-bg);color:var(--img-c);border:1px solid var(--img-c)}.bimg:hover{background:#1c1435}
.bweb{background:var(--web-bg);color:var(--web-c);border:1px solid var(--web-c)}.bweb:hover{background:#2a1e00}
.sm{padding:5px 10px;font-size:9px;border-radius:5px}
.stats{display:flex;gap:14px;padding:4px 0;font-size:9px;flex-wrap:wrap;margin-bottom:8px}
.stat{display:flex;align-items:center;gap:4px}
.dot{width:5px;height:5px;border-radius:50%}
.tb{display:flex;gap:5px;align-items:center;flex-wrap:wrap;margin-bottom:10px;padding:8px 10px;background:var(--panel);border:1px solid var(--border);border-radius:8px}
.ts{width:1px;height:20px;background:var(--border);flex-shrink:0;margin:0 3px}
.tl{font-size:8px;color:var(--muted);letter-spacing:1px;flex-shrink:0}
.vlwrap{border:1px solid var(--border);border-radius:10px;overflow:hidden}
.vlh{display:flex;gap:8px;padding:6px 12px;background:rgba(0,0,0,.5);font-size:8px;color:var(--muted);letter-spacing:1px}
.vi{display:flex;align-items:center;gap:9px;padding:8px 12px;background:var(--ch);border-bottom:1px solid var(--border);border-left:3px solid transparent;transition:background .12s;animation:fi .14s ease}
.vi:last-child{border-bottom:none}
.vi:hover{background:#17172a}
.vi.sel{background:rgba(0,229,255,.04);border-left-color:var(--accent)}
.vi.done{border-left-color:var(--green)}
.vi.error{border-left-color:var(--a2)}
@keyframes fi{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:none}}
.ck{flex-shrink:0;cursor:pointer;user-select:none}
.ck input{display:none}
.ck-b{width:14px;height:14px;border:1.5px solid var(--muted);border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:9px;transition:all .14s}
.ck input:checked~.ck-b{background:var(--accent);border-color:var(--accent);color:var(--bg)}
.vth{width:68px;height:43px;border-radius:5px;background:var(--border);flex-shrink:0;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer}
.vth img{width:100%;height:100%;object-fit:cover}
.vinfo{flex:1;min-width:0;cursor:pointer}
.vt{font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-family:'Noto Sans SC',sans-serif;margin-bottom:2px}
.vu{font-size:8.5px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.vm{display:flex;gap:4px;margin-top:3px;flex-wrap:wrap}
.badge{font-size:7px;padding:1px 5px;border-radius:3px}
.bbili{background:rgba(0,181,226,.15);color:#00b5e2}
.bdy{background:rgba(255,61,107,.15);color:var(--a2)}
.bok{background:rgba(0,230,118,.15);color:var(--green)}
.vacts{display:flex;gap:4px;flex-shrink:0}
.vst{font-size:8px;flex-shrink:0;width:60px;text-align:right}
.sw{color:var(--muted)}.sd{color:var(--green)}.se{color:var(--a2)}
.logbox{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:8px 11px;font-size:9px;height:88px;overflow-y:auto;margin-top:12px}
.ll{padding:1px 0;line-height:1.5}
.li{color:var(--accent)}.lo{color:var(--green)}.le{color:var(--a2)}.lw{color:var(--warn)}
.mov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:500;align-items:center;justify-content:center;padding:12px}
.mov.open{display:flex}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:13px;padding:22px;width:100%;max-width:540px;max-height:92vh;overflow-y:auto}
.modal h3{font-size:12px;color:var(--accent);margin-bottom:14px;letter-spacing:1px}
.mc{float:right;font-size:16px;cursor:pointer;color:var(--muted);background:none;border:none;font-family:'Space Mono',monospace}
.mc:hover{color:var(--text)}
.mthumb{width:100%;border-radius:7px;margin-bottom:12px;border:1px solid var(--border)}
.minfo{font-size:11px;color:var(--muted);line-height:1.9;font-family:'Noto Sans SC',sans-serif;margin-bottom:14px}
.minfo strong{color:var(--text)}
.minfo a{color:var(--accent);font-size:9px;word-break:break-all}
.mdlg{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
.mdlb{display:flex;align-items:center;gap:10px;padding:13px 16px;border-radius:10px;text-decoration:none;font-family:'Space Mono',monospace;font-size:13px;font-weight:700;cursor:pointer;border:none;width:100%;transition:all .14s;line-height:1}
.mdlb:active{transform:scale(.98)}
.mico{font-size:22px;flex-shrink:0}
.mlbl{flex:1;text-align:left}
.msub{font-size:9px;font-weight:400;opacity:.75;display:block;margin-top:2px;font-family:'Noto Sans SC',sans-serif}
.marr{opacity:.45;font-size:13px}
.mv{background:var(--vid-bg);color:var(--vid-c);border:1.5px solid var(--vid-c);box-shadow:0 0 14px rgba(0,229,255,.15)}.mv:hover{background:#0d2a36}
.ma{background:var(--aud-bg);color:var(--aud-c);border:1.5px solid var(--aud-c);box-shadow:0 0 12px rgba(0,230,118,.12)}.ma:hover{background:#0a2818}
.mi{background:var(--img-bg);color:var(--img-c);border:1px solid var(--img-c)}.mi:hover{background:#1c1435}
.ol{font-size:9px;color:var(--muted);letter-spacing:1px;margin:10px 0 6px;font-weight:600}
.ogd{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.ob{display:block;padding:8px 4px;border-radius:7px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:10px;text-align:center;text-decoration:none;transition:all .13s;font-weight:600;font-family:'Space Mono',monospace}
.ob:hover,.ob:active{border-color:var(--web-c);color:var(--web-c)}
.ob small{display:block;font-size:8px;color:var(--muted);font-weight:400;margin-top:1px;font-family:'Noto Sans SC',sans-serif}
.macts{display:flex;gap:7px;flex-wrap:wrap;margin-top:10px}
.gs{margin-bottom:18px}
.gs h4{font-size:10px;letter-spacing:1px;margin-bottom:7px;color:var(--accent)}
.gs p{font-size:12px;color:var(--text);line-height:1.9;font-family:'Noto Sans SC',sans-serif}
code.blk{display:block;background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:9px 12px;font-size:9px;color:var(--green);margin:7px 0;line-height:1.8;font-family:'Space Mono',monospace;white-space:pre-wrap;word-break:break-all}
.empty{padding:48px 20px;text-align:center;color:var(--muted);font-family:'Noto Sans SC',sans-serif}
.empty .ico{font-size:42px;margin-bottom:10px}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(80px);background:#1a1a2e;border:1px solid var(--accent);color:var(--accent);padding:8px 18px;border-radius:8px;font-size:11px;z-index:999;transition:transform .25s;pointer-events:none;white-space:nowrap}
.toast.show{transform:translateX(-50%) translateY(0)}
::-webkit-scrollbar{width:3px;height:3px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
@media(max-width:640px){
  .tab{padding:10px 12px;font-size:9px}
  .vlh{display:none}
  .vi{flex-wrap:wrap;gap:7px}
  .vacts{width:100%;margin-top:4px;gap:5px}
  .vst{display:none}
  .hb .pt:not(.pm){display:none}
  .ogd{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<header>
<div class="hi">
  <div class="logo">‚¨á</div>
  <div><div class="ht">BILIDOWN</div><div class="hs">Bilibili &amp; Douyin ‚Äî PC &amp; ƒêi·ªán tho·∫°i</div></div>
  <div class="hb">
    <span class="pt pb">BILIBILI</span>
    <span class="pt pd">DOUYIN</span>
    <span class="pt pm">üì± MOBILE OK</span>
  </div>
</div>
<div class="tabbar"><div class="tabs">
  <button class="tab on" onclick="sw('input')">üì• NH·∫¨P LINK</button>
  <button class="tab" onclick="sw('queue')">üìã DANH S√ÅCH <span class="tb2" id="qc">0</span></button>
  <button class="tab" onclick="sw('guide')">üìñ H∆Ø·ªöNG D·∫™N</button>
</div></div>
</header>

<div class="w">

<!-- TAB NH·∫¨P LINK -->
<div class="pane on" id="pane-input">
  <div class="ibox ibg" style="margin-top:14px">
    <b>üì± D√πng ƒë∆∞·ª£c tr√™n ƒëi·ªán tho·∫°i!</b> Nh·∫•n n√∫t t·∫£i ‚Üí trang web m·ªü ra ƒë√£ ƒëi·ªÅn s·∫µn link ‚Üí nh·∫•n Download l√† xong.<br>
    <b>‚ö° L·ªçc link t·ª± ƒë·ªông</b> ‚Äî D√°n text l·∫´n ch·ªØ Trung ƒë·ªÅu OK: <code>„ÄêÊ≠ª‰∫°Âä®Áîª„Äë https://bilibili.com/...</code>
  </div>
  <div class="card">
    <span class="cl">D√ÅN LINK / TEXT C√ì LINK</span>
    <textarea id="linkin" placeholder="D√°n link v√†o ƒë√¢y:
„ÄêÂÜ•Ê≤≥Ôºà‰∫∫ËØ°Áñë‰∫ëÔºâÁ¨¨‰πùÈõÜ„Äë https://www.bilibili.com/video/BV1EzGiz1ETU/
https://v.douyin.com/aBcDeFg/
https://b23.tv/aBcDe"></textarea>
  </div>
  <div class="card">
    <div class="opts">
      <div class="og"><label>CH·∫§T L∆Ø·ª¢NG</label>
        <select id="qsel">
          <option value="bestvideo+bestaudio/best">üèÜ Cao nh·∫•t</option>
          <option value="bestvideo[height<=1080]+bestaudio/best[height<=1080]">üé¨ 1080p</option>
          <option value="bestvideo[height<=720]+bestaudio/best[height<=720]">üì∫ 720p</option>
          <option value="bestvideo[height<=480]+bestaudio/best[height<=480]">üì± 480p</option>
        </select>
      </div>
      <div class="og"><label>VIDEO FORMAT</label>
        <select id="vfmt"><option>mp4</option><option>mkv</option><option>webm</option></select>
      </div>
      <div class="og"><label>AUDIO FORMAT</label>
        <select id="afmt"><option>mp3</option><option>aac</option><option>m4a</option><option>opus</option><option>wav</option><option>flac</option></select>
      </div>
    </div>
  </div>
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button class="btn bprim" onclick="parse()">üîç PH√ÇN T√çCH LINK</button>
    <button class="btn bsec" onclick="document.getElementById('linkin').value=''">üóë X√≥a</button>
  </div>
</div>

<!-- TAB DANH S√ÅCH -->
<div class="pane" id="pane-queue">
  <div class="stats" style="margin-top:14px">
    <span class="stat"><span class="dot" style="background:var(--muted)"></span>T·ªïng: <b id="st-t">0</b></span>
    <span class="stat"><span class="dot" style="background:var(--accent)"></span>Ch·ªçn: <b id="st-s">0</b></span>
    <span class="stat"><span class="dot" style="background:var(--green)"></span>Xong: <b id="st-d">0</b></span>
  </div>
  <div class="tb">
    <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:10px">
      <input type="checkbox" id="chkall" onchange="toggleAll(this)" style="accent-color:var(--accent)"> Ch·ªçn t·∫•t c·∫£
    </label>
    <span class="ts"></span>
    <span class="tl">T·∫¢I CH·ªåN:</span>
    <button class="btn bvid sm" id="btn-bv" onclick="batchSel('video')" disabled>üìπ VIDEO+√ÇM</button>
    <button class="btn baud sm" id="btn-ba" onclick="batchSel('audio')" disabled>üéµ CH·ªà AUDIO</button>
    <span class="ts"></span>
    <span class="tl">T·∫§T C·∫¢:</span>
    <button class="btn bvid sm" onclick="batchAll('video')">üìπ VIDEO+√ÇM</button>
    <button class="btn baud sm" onclick="batchAll('audio')">üéµ CH·ªà AUDIO</button>
    <span style="flex:1"></span>
    <button class="btn bdel sm" onclick="clearQ()">üóë X√≥a</button>
  </div>
  <div id="vwrap">
    <div class="empty"><div class="ico">üì≠</div><p>Ch∆∞a c√≥ link ‚Äî nh·∫≠p ·ªü tab NH·∫¨P LINK</p></div>
  </div>
  <div class="logbox" id="logbox"></div>
</div>

<!-- TAB H∆Ø·ªöNG D·∫™N -->
<div class="pane" id="pane-guide">
  <div class="card" style="margin-top:14px;line-height:1.9">
    <div class="gs"><h4>‚ë† ƒêI·ªÜN THO·∫†I ‚Äî c√°ch t·∫£i</h4>
      <p>1. D√°n link ‚Üí nh·∫•n <b>Ph√¢n T√≠ch Link</b><br>
      2. Nh·∫•n <b style="color:var(--vid-c)">üìπ VIDEO+√ÇM</b> ho·∫∑c <b style="color:var(--aud-c)">üéµ CH·ªà AUDIO</b><br>
      3. Trang t·∫£i m·ªü ra ‚Üí nh·∫•n <b>Download</b> ‚Üí xong<br>
      4. N·∫øu 1 trang l·ªói ‚Üí nh·∫•n <b>üåê Trang kh√°c</b> trong popup</p>
    </div>
    <div class="gs"><h4>‚ë° M√ÅY T√çNH ‚Äî yt-dlp (m·∫°nh h∆°n)</h4>
      <code class="blk"># C√†i:
pip install yt-dlp

# Video 1080p c√≥ √¢m thanh:
yt-dlp -f "bestvideo[height&lt;=1080]+bestaudio" --merge-output-format mp4 [URL]

# Douyin c·∫ßn cookie Chrome (ƒëƒÉng nh·∫≠p Chrome tr∆∞·ªõc):
yt-dlp --cookies-from-browser chrome [URL]

# Ch·ªâ audio MP3:
yt-dlp -x --audio-format mp3 [URL]</code>
    </div>
    <div class="gs"><h4>‚ë¢ C√ÅC TRANG T·∫¢I VIDEO (6 trang d·ª± ph√≤ng)</h4>
      <p>ü•ú PeanutDL &nbsp;|&nbsp; üì∏ SnapVideoTools &nbsp;|&nbsp; üîç Seekin.ai<br>üíæ SaveTube &nbsp;|&nbsp; ‚¨á SSSTik &nbsp;|&nbsp; üì∫ bilibili.ovh</p>
    </div>
  </div>
</div>

</div>

<!-- MODAL -->
<div class="mov" id="mov">
<div class="modal">
  <button class="mc" onclick="closeMod()">‚úï</button>
  <h3 id="mtitle">‚¨á T·∫¢I VIDEO</h3>
  <img id="mthumb" src="" alt="" style="display:none" onerror="this.style.display='none'">
  <div class="minfo" id="minfo"></div>
  <div class="mdlg" id="mdlg"></div>
  <div class="ol" id="ol" style="display:none">üåê TRANG KH√ÅC ‚Äî n·∫øu trang tr√™n l·ªói</div>
  <div class="ogd" id="ogd"></div>
  <div class="macts" id="macts"></div>
</div>
</div>

<div class="toast" id="toast"></div>

<script>
const URL_RE=/https?:\/\/(?:(?:www\.)?bilibili\.com\/video\/[A-Za-z0-9_/?=&%#.\-]+|b23\.tv\/[A-Za-z0-9]+|(?:www\.)?douyin\.com\/video\/\d+|v\.douyin\.com\/[A-Za-z0-9]+|vm\.tiktok\.com\/[A-Za-z0-9]+)[^\s\u4e00-\u9fff"'<>]*/g;
const SITES=[
  {n:'ü•ú PeanutDL',d:'Bili+Douyin',bili:u=>`https://peanutdl.com/en/bilibili?url=${E(u)}`,dy:u=>`https://peanutdl.com/en/douyin?url=${E(u)}`},
  {n:'üì∏ SnapVideo',d:'ƒêa n·ªÅn t·∫£ng',bili:u=>`https://snapvideotools.com/?url=${E(u)}`,dy:u=>`https://snapvideotools.com/?url=${E(u)}`},
  {n:'üîç Seekin.ai',d:'Bili+Douyin',bili:u=>`https://www.seekin.ai/bilibili-downloader/?url=${E(u)}`,dy:u=>`https://www.seekin.ai/douyin-downloader/?url=${E(u)}`},
  {n:'üíæ SaveTube',d:'ƒêa n·ªÅn t·∫£ng',bili:u=>`https://savetube.me/?url=${E(u)}`,dy:u=>`https://savetube.me/?url=${E(u)}`},
  {n:'‚¨á SSSTik',d:'Douyin/TikTok',bili:u=>`https://snapvideotools.com/?url=${E(u)}`,dy:u=>`https://ssstik.io/?url=${E(u)}`},
  {n:'üì∫ bilibili.ovh',d:'Bilibili',bili:u=>`https://bilibili.ovh/?url=${E(u)}`,dy:u=>`https://snapvideotools.com/?url=${E(u)}`},
];
function E(u){return encodeURIComponent(u)}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function plat(u){return(u.includes('bilibili.com')||u.includes('b23.tv'))?'bilibili':'douyin'}
function sid(u){const m=u.match(/\/(BV[A-Za-z0-9]+)/)||u.match(/\/video\/(\d+)/);return m?m[1]:u.slice(-9)}
function su(s,url,p){return p==='bilibili'?s.bili(url):s.dy(url)}
let items=[],sel=new Set();
function parse(){
  const raw=document.getElementById('linkin').value.trim();
  if(!raw){toast('Ch∆∞a nh·∫≠p link!');return}
  const urls=(raw.match(URL_RE)||[]).map(u=>u.replace(/[.,!?;Ôºå„ÄÇÔºÅÔºüÔºõ\])}]+$/,'')).filter((u,i,a)=>a.indexOf(u)===i);
  if(!urls.length){log('e','Kh√¥ng t√¨m th·∫•y URL h·ª£p l·ªá');toast('Kh√¥ng c√≥ link Bilibili/Douyin!');return}
  const ex=new Set(items.map(v=>v.url));let added=0;
  urls.forEach(url=>{
    if(ex.has(url)){log('w','ƒê√£ c√≥: '+url.slice(0,50));return}
    const p=plat(url);
    const it={url,plat:p,sid:sid(url),title:'['+p.toUpperCase()+'] '+sid(url),thumb:null,status:'wait'};
    items.push(it);ex.add(url);added++;
    fetch('https://noembed.com/embed?url='+E(url),{signal:AbortSignal.timeout(8000)})
      .then(r=>r.json()).then(d=>{let c=false;if(d.title&&d.title!='undefined'){it.title=d.title;c=true}if(d.thumbnail_url){it.thumb=d.thumbnail_url;c=true}if(c)render();}).catch(()=>{});
  });
  log('i','T√¨m '+urls.length+' link, th√™m '+added+' m·ª•c');render();sw('queue');toast('Th√™m '+added+' video ‚úì');
}
function render(){
  const el=document.getElementById('vwrap');upSt();
  if(!items.length){el.innerHTML='<div class="empty"><div class="ico">üì≠</div><p>Ch∆∞a c√≥ link ‚Äî nh·∫≠p ·ªü tab NH·∫¨P LINK</p></div>';return}
  el.innerHTML='<div class="vlwrap"><div class="vlh"><span style="width:20px">‚òë</span><span style="width:72px">THUMB</span><span style="width:80px">PLATFORM</span><span style="flex:1">T√äN VIDEO / URL</span><span style="width:240px;text-align:right">THAO T√ÅC</span></div>'+items.map(makeRow).join('')+'</div>';
}
function makeRow(v,i){
  const th=v.thumb?`<img src="${esc(v.thumb)}" loading="lazy" onerror="this.parentElement.innerHTML='${v.plat==='bilibili'?'üì∫':'üì±'}'">`:(v.plat==='bilibili'?'üì∫':'üì±');
  const chk=sel.has(i);
  const sc=v.status==='done'?'done':v.status==='error'?'error':'';
  const stxt=v.status==='done'?'<span class="vst sd">‚úìXONG</span>':'<span class="vst sw">CH·ªúT·∫¢I</span>';
  const s0=su(SITES[0],v.url,v.plat),s1=su(SITES[1],v.url,v.plat);
  return `<div class="vi ${sc} ${chk?'sel':''}" id="vi${i}">
  <label class="ck" onclick="event.stopPropagation()"><input type="checkbox" ${chk?'checked':''} onchange="togVI(${i},this.checked)"><span class="ck-b">${chk?'‚úì':'‚òê'}</span></label>
  <div class="vth" onclick="showMod(${i})">${th}</div>
  <div style="width:80px;flex-shrink:0"><span class="badge ${v.plat==='bilibili'?'bbili':'bdy'}">${v.plat.toUpperCase()}</span></div>
  <div class="vinfo" onclick="showMod(${i})">
    <div class="vt">${esc(v.title)}</div>
    <div class="vu">${esc(v.url)}</div>
    <div class="vm">${v.status==='done'?'<span class="badge bok">‚úìXONG</span>':''}</div>
  </div>
  <div class="vacts">
    <a class="btn bvid sm" href="${esc(s0)}" target="_blank" rel="noopener" onclick="markDone(${i});log('o','M·ªü trang VIDEO+√ÇM...')">üìπ VIDEO+√ÇM</a>
    <a class="btn baud sm" href="${esc(s1)}" target="_blank" rel="noopener" onclick="markDone(${i});log('o','M·ªü trang AUDIO...')">üéµ AUDIO</a>
    <button class="btn bweb sm" onclick="event.stopPropagation();showMod(${i})">üåê Trang kh√°c</button>
    <button class="btn bdel sm" onclick="event.stopPropagation();removeItem(${i})">‚úï</button>
  </div>
  ${stxt}
</div>`;
}
function togVI(i,c){c?sel.add(i):sel.delete(i);const el=document.getElementById('vi'+i);if(el){el.classList.toggle('sel',c);const b=el.querySelector('.ck-b');if(b)b.textContent=c?'‚úì':'‚òê'}upSt();updBtns()}
function toggleAll(cb){cb.checked?items.forEach((_,i)=>sel.add(i)):sel.clear();items.forEach((_,i)=>{const el=document.getElementById('vi'+i);if(!el)return;el.classList.toggle('sel',cb.checked);const b=el.querySelector('.ck-b');if(b)b.textContent=cb.checked?'‚úì':'‚òê';const ck=el.querySelector('input[type=checkbox]');if(ck)ck.checked=cb.checked});upSt();updBtns()}
function updBtns(){const d=sel.size===0;document.getElementById('btn-bv').disabled=d;document.getElementById('btn-ba').disabled=d}
function upSt(){document.getElementById('qc').textContent=items.length;document.getElementById('st-t').textContent=items.length;document.getElementById('st-s').textContent=sel.size;document.getElementById('st-d').textContent=items.filter(v=>v.status==='done').length}
function batchSel(type){[...sel].forEach(i=>{const v=items[i];if(!v)return;window.open(su(type==='video'?SITES[0]:SITES[1],v.url,v.plat),'_blank');markDone(i)});log('o','ƒê√£ m·ªü '+sel.size+' trang t·∫£i')}
function batchAll(type){items.forEach((v,i)=>{window.open(su(type==='video'?SITES[0]:SITES[1],v.url,v.plat),'_blank');markDone(i)});log('o','ƒê√£ m·ªü '+items.length+' trang t·∫£i')}
function showMod(i){
  const v=items[i];if(!v)return;
  const p=v.plat;
  document.getElementById('mtitle').textContent='‚¨á T·∫¢I VIDEO';
  const th=document.getElementById('mthumb');th.style.display=v.thumb?'block':'none';if(v.thumb)th.src=v.thumb;
  document.getElementById('minfo').innerHTML=`<strong>T√™n:</strong> ${esc(v.title)}<br><strong>Platform:</strong> ${p.toUpperCase()}<br><strong>URL:</strong> <a href="${esc(v.url)}" target="_blank">${esc(v.url)}</a>`;
  document.getElementById('mdlg').innerHTML=`
    <a class="mdlb mv" href="${esc(su(SITES[0],v.url,p))}" target="_blank" rel="noopener" onclick="markDone(${i});log('o','M·ªü trang VIDEO+√ÇM...')">
      <span class="mico">üìπ</span><span class="mlbl">T·∫¢I VIDEO + √ÇM THANH<span class="msub">qua ${SITES[0].n} ‚Äî Nh·∫•n v√†o r·ªìi nh·∫•n Download</span></span><span class="marr">‚Ä∫</span>
    </a>
    <a class="mdlb ma" href="${esc(su(SITES[1],v.url,p))}" target="_blank" rel="noopener" onclick="markDone(${i});log('o','M·ªü trang AUDIO...')">
      <span class="mico">üéµ</span><span class="mlbl">T·∫¢I AUDIO (MP3)<span class="msub">qua ${SITES[1].n}</span></span><span class="marr">‚Ä∫</span>
    </a>
    ${v.thumb?`<a class="mdlb mi" href="${esc(v.thumb)}" download target="_blank"><span class="mico">üñº</span><span class="mlbl">T·∫¢I ·∫¢NH THUMBNAIL<span class="msub">·∫¢nh b√¨a video</span></span><span class="marr">‚Ä∫</span></a>`:''}`;
  document.getElementById('ol').style.display='';
  document.getElementById('ogd').innerHTML=SITES.map(s=>`<a class="ob" href="${esc(su(s,v.url,p))}" target="_blank" rel="noopener" onclick="markDone(${i})">${s.n}<small>${s.d}</small></a>`).join('');
  document.getElementById('macts').innerHTML=`<button class="btn bsec sm" onclick="navigator.clipboard?.writeText('${esc(v.url).replace(/'/g,"\\'")}');toast('ƒê√£ copy URL!')">üîó Copy URL</button><button class="btn bsec sm" onclick="closeMod()">ƒê√≥ng</button>`;
  document.getElementById('mov').classList.add('open');
}
function closeMod(){document.getElementById('mov').classList.remove('open')}
document.getElementById('mov').addEventListener('click',e=>{if(e.target===document.getElementById('mov'))closeMod()});
function markDone(i){if(items[i]){items[i].status='done';render()}}
function removeItem(i){items.splice(i,1);sel.clear();render();log('w','ƒê√£ x√≥a')}
function clearQ(){items=[];sel.clear();render();log('w','ƒê√£ x√≥a h√†ng ƒë·ª£i')}
function log(type,msg){const b=document.getElementById('logbox');const d=document.createElement('div');d.className='ll l'+type;d.textContent='['+new Date().toLocaleTimeString('vi-VN')+'] '+msg;b.appendChild(d);b.scrollTop=b.scrollHeight}
function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200)}
function sw(name){document.querySelectorAll('.pane').forEach(p=>p.classList.remove('on'));document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));document.getElementById('pane-'+name).classList.add('on');const m={input:0,queue:1,guide:2};document.querySelectorAll('.tab')[m[name]].classList.add('on')}
window.onload=()=>log('i','BiliDown s·∫µn s√†ng ‚Äî D√°n link v√† nh·∫•n Ph√¢n T√≠ch Link üì±');
</script>
</body>
</html>
