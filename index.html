<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BiliDown â€” Táº£i Video Bilibili & Douyin</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0a0f;--panel:#111118;--border:#1e1e2e;--accent:#00e5ff;--a2:#ff3d6b;--a3:#7b61ff;--green:#00e676;--warn:#ffb300;--text:#e0e0f0;--muted:#555570;--card:#14141f;--ch:#1a1a2a}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'Space Mono',monospace;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,229,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,229,255,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0}
.w{max-width:1060px;margin:0 auto;padding:0 16px;position:relative;z-index:1}

/* HEADER */
header{padding:18px 0 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.logo{width:38px;height:38px;background:linear-gradient(135deg,var(--accent),var(--a3));border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
header h1{font-size:18px;letter-spacing:2px;color:var(--accent)}
header p{font-size:9px;color:var(--muted);margin-top:2px;font-family:'Noto Sans SC',sans-serif}
.htags{margin-left:auto;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.ptag{padding:2px 8px;border-radius:4px;font-size:8px;letter-spacing:1px;border:1px solid}
.ptag.bili{color:#00b5e2;border-color:#00b5e2;background:rgba(0,181,226,0.08)}
.ptag.dy{color:var(--a2);border-color:var(--a2);background:rgba(255,61,107,0.08)}
.api-dot{font-size:8px;padding:2px 9px;border-radius:10px;border:1px solid var(--border);color:var(--muted)}
.api-dot.ok{color:var(--green);border-color:var(--green)}
.api-dot.err{color:var(--a2);border-color:var(--a2)}
.api-dot.chk{color:var(--warn);border-color:var(--warn)}

/* TABS */
.tabs{display:flex;margin:16px 0 0;border-bottom:1px solid var(--border)}
.tab{padding:8px 16px;font-size:10px;letter-spacing:1px;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:all .2s;background:none;border-top:none;border-left:none;border-right:none;font-family:'Space Mono',monospace}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab:hover:not(.active){color:var(--text)}
.tbadge{background:var(--a3);color:#fff;border-radius:8px;font-size:8px;padding:1px 5px;margin-left:4px}
.tab-pane{display:none;padding:16px 0}
.tab-pane.active{display:block}

/* CARD */
.card{background:var(--panel);border:1px solid var(--border);border-radius:9px;padding:14px;margin-bottom:12px}
.clabel{font-size:9px;color:var(--muted);letter-spacing:1px;margin-bottom:7px;display:block}

/* INPUTS */
textarea,input[type=text]{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:11px;border-radius:5px;padding:9px 11px;resize:vertical;outline:none;transition:border-color .2s}
textarea{height:96px}
textarea:focus,input:focus{border-color:var(--accent)}

/* NOTICE BOXES */
.notice{background:rgba(255,179,0,0.05);border:1px solid rgba(255,179,0,0.2);border-radius:7px;padding:9px 13px;font-size:10px;color:var(--warn);margin-bottom:12px;line-height:1.7;font-family:'Noto Sans SC',sans-serif}
.info-box{background:rgba(0,229,255,0.04);border:1px solid rgba(0,229,255,0.15);border-radius:7px;padding:9px 13px;font-size:10px;color:var(--accent);margin-bottom:12px;line-height:1.7;font-family:'Noto Sans SC',sans-serif}
.info-box b{font-family:'Space Mono',monospace}

/* OPTIONS */
.opts{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
.og{display:flex;flex-direction:column;gap:4px}
.og label{font-size:9px;color:var(--muted);letter-spacing:1px}
select{background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:10px;padding:5px 8px;border-radius:4px;outline:none;cursor:pointer}
select:focus{border-color:var(--accent)}

/* BUTTONS */
.btn{padding:7px 14px;border-radius:5px;font-family:'Space Mono',monospace;font-size:10px;letter-spacing:.5px;cursor:pointer;border:none;transition:all .16s;display:inline-flex;align-items:center;gap:5px;white-space:nowrap}
.bp{background:var(--accent);color:var(--bg);font-weight:700}
.bp:hover{background:#33eeff;transform:translateY(-1px)}
.bv{background:rgba(0,229,255,0.1);color:var(--accent);border:1px solid var(--accent)}
.bv:hover{background:rgba(0,229,255,0.2)}
.ba{background:rgba(0,230,118,0.1);color:var(--green);border:1px solid var(--green)}
.ba:hover{background:rgba(0,230,118,0.2)}
.bi{background:rgba(123,97,255,0.1);color:var(--a3);border:1px solid var(--a3)}
.byt{background:rgba(255,179,0,0.1);color:var(--warn);border:1px solid var(--warn)}
.byt:hover{background:rgba(255,179,0,0.2)}
.byta{background:rgba(255,100,0,0.1);color:#ff8c00;border:1px solid #ff8c00}
.byta:hover{background:rgba(255,100,0,0.2)}
.bi:hover{background:rgba(123,97,255,0.2)}
.bs{background:transparent;color:var(--text);border:1px solid var(--border)}
.bs:hover{border-color:var(--text)}
.bd{background:transparent;color:var(--a2);border:1px solid var(--a2)}
.bd:hover{background:rgba(255,61,107,0.08)}
.btn:active{transform:scale(.97)}
.btn:disabled{opacity:.3;cursor:not-allowed;transform:none!important}
.sm{padding:4px 9px;font-size:9px;border-radius:4px}

/* STATS */
.stats{display:flex;gap:14px;padding:6px 0;margin-bottom:10px;font-size:9px;flex-wrap:wrap}
.stat{display:flex;align-items:center;gap:4px}
.dot{width:5px;height:5px;border-radius:50%}
.da{background:var(--muted)}.ds{background:var(--accent)}.dd{background:var(--green)}.de{background:var(--a2)}

/* TOOLBAR */
.tb{display:flex;gap:7px;margin-bottom:10px;flex-wrap:wrap;align-items:center}

/* VIDEO LIST */
.vlh{display:flex;align-items:center;gap:8px;padding:7px 11px;background:rgba(0,0,0,0.3);border:1px solid var(--border);border-radius:7px 7px 0 0;font-size:8px;color:var(--muted);letter-spacing:1px}
.vlist{border:1px solid var(--border);border-top:none;border-radius:0 0 7px 7px;overflow:hidden}
.vi{display:flex;align-items:center;gap:9px;padding:8px 11px;background:var(--card);border-bottom:1px solid var(--border);transition:background .12s;border-left:3px solid transparent}
.vi:last-child{border-bottom:none}
.vi:hover{background:var(--ch)}
.vi.sel{background:rgba(0,229,255,0.04);border-left-color:var(--accent)}
.vi.loading{border-left-color:var(--warn)}
.vi.done{border-left-color:var(--green)}
.vi.error{border-left-color:var(--a2)}

/* CHECKBOX */
.ck{flex-shrink:0;cursor:pointer;user-select:none}
.ck input{display:none}
.ck-box{width:14px;height:14px;border:1px solid var(--muted);border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:9px;transition:all .15s}
.ck input:checked+.ck-box{background:var(--accent);border-color:var(--accent);color:var(--bg)}

/* THUMB */
.vthumb{width:66px;height:41px;border-radius:4px;background:var(--border);flex-shrink:0;overflow:hidden;display:flex;align-items:center;justify-content:center;font-size:15px;border:1px solid var(--border);cursor:pointer;position:relative}
.vthumb img{width:100%;height:100%;object-fit:cover}
.vthumb .pov{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);font-size:18px}
.vthumb:hover .pov{display:flex}

/* INFO */
.vinfo{flex:1;min-width:0;cursor:pointer}
.vtitle{font-size:11px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-family:'Noto Sans SC',sans-serif;margin-bottom:2px}
.vurl{font-size:8px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:3px}
.vmeta{display:flex;gap:5px;flex-wrap:wrap;align-items:center}
.badge{font-size:7px;padding:1px 5px;border-radius:3px}
.bbili{background:rgba(0,181,226,0.15);color:#00b5e2}
.bdy{background:rgba(255,61,107,0.15);color:var(--a2)}
.bq{background:rgba(123,97,255,0.15);color:var(--a3)}
.bok{background:rgba(0,230,118,0.15);color:var(--green)}

/* ACTIONS */
.vacts{display:flex;gap:4px;flex-shrink:0;flex-wrap:wrap;justify-content:flex-end}

/* STATUS */
.vstat{font-size:8px;flex-shrink:0;width:58px;text-align:right;font-family:'Space Mono',monospace}
.sw{color:var(--muted)}.sl{color:var(--warn)}.sd{color:var(--green)}.se{color:var(--a2)}

/* PROGRESS */
.pw{height:2px;background:var(--border);border-radius:1px;margin-top:4px;display:none}
.pb{height:100%;background:var(--accent);border-radius:1px;transition:width .4s}
.vi.loading .pw{display:block}

/* EMPTY */
.empty{padding:48px 20px;text-align:center;color:var(--muted);font-family:'Noto Sans SC',sans-serif}
.empty .ico{font-size:38px;margin-bottom:10px}

/* LOG */
.logbox{background:var(--bg);border:1px solid var(--border);border-radius:7px;padding:9px 11px;font-size:9px;height:100px;overflow-y:auto;margin-top:12px}
.ll{padding:1px 0}
.li{color:var(--accent)}.lo{color:var(--green)}.le{color:var(--a2)}.lw{color:var(--warn)}

/* MODAL */
.mov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:300;align-items:center;justify-content:center}
.mov.open{display:flex}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:11px;padding:20px;width:500px;max-width:96vw;max-height:92vh;overflow-y:auto}
.modal h3{font-size:12px;color:var(--accent);margin-bottom:12px;letter-spacing:1px}
.mc{float:right;font-size:15px;cursor:pointer;color:var(--muted);background:none;border:none}
.mc:hover{color:var(--text)}
.modal img{width:100%;border-radius:5px;margin-bottom:11px;border:1px solid var(--border)}
.minfo{font-size:10px;color:var(--muted);line-height:1.8;font-family:'Noto Sans SC',sans-serif}
.minfo strong{color:var(--text)}
.macts{display:flex;gap:7px;flex-wrap:wrap;margin-top:13px}

/* DL PROGRESS */
.dlp{margin-top:10px;display:none}
.dlbar{height:5px;background:var(--border);border-radius:3px;overflow:hidden;margin:5px 0}
.dlfill{height:100%;background:var(--accent);border-radius:3px;transition:width .3s;width:0}
.dlstat{font-size:9px;color:var(--muted)}

/* GUIDE */
.gs{margin-bottom:18px}
.gs h4{color:var(--a2);font-size:10px;letter-spacing:1px;margin-bottom:7px;font-family:'Space Mono',monospace}
.gs p{font-size:12px;color:var(--text);line-height:1.8;font-family:'Noto Sans SC',sans-serif}
code.blk{display:block;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:9px 11px;font-size:9px;color:var(--green);margin:7px 0;line-height:1.8;word-break:break-all;font-family:'Space Mono',monospace}

::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
::-webkit-scrollbar-thumb:hover{background:var(--muted)}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.vi{animation:fadeIn .16s ease}
@keyframes spin{to{transform:rotate(360deg)}}
.spin{width:9px;height:9px;border:1.5px solid transparent;border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;display:inline-block}
</style>
</head>
<body>
<div class="w">

<!-- HEADER -->
<header>
  <div class="logo">â¬‡</div>
  <div>
    <h1>BILIDOWN</h1>
    <p>Táº£i trá»±c tiáº¿p tá»« trÃ¬nh duyá»‡t â€” Bilibili & Douyin</p>
  </div>
  <div class="htags">
    <span class="ptag bili">BILIBILI</span>
    <span class="ptag dy">DOUYIN</span>
    <span class="api-dot" id="api-dot">â— Cobalt API</span>
  </div>
</header>

<!-- TABS -->
<div class="tabs">
  <button class="tab active" onclick="sw('input')">ğŸ“¥ NHáº¬P LINK</button>
  <button class="tab" onclick="sw('queue')">ğŸ“‹ DANH SÃCH <span class="tbadge" id="qc">0</span></button>
  <button class="tab" onclick="sw('guide')">ğŸ“– HÆ¯á»šNG DáºªN</button>
</div>

<!-- â•â•â• TAB NHáº¬P LINK â•â•â• -->
<div class="tab-pane active" id="tab-input">
  <div class="info-box">
    <b>âœ… Táº¢I TRá»°C TIáº¾P â€” KhÃ´ng cáº§n cÃ i gÃ¬ thÃªm</b><br>
    Tool dÃ¹ng <b>Cobalt.tools API</b> â€” má»—i video cÃ³ 3 nÃºt táº£i:<br>
    <b style="color:var(--accent)">ğŸ“¹ VIDEO+Ã‚M</b> &nbsp;Â·&nbsp; <b style="color:var(--green)">ğŸµ CHá»ˆ AUDIO</b> &nbsp;Â·&nbsp; <b style="color:var(--a3)">ğŸ–¼ áº¢NH</b>
  </div>
  <div class="card">
    <span class="clabel">DÃN LINK / TEXT CÃ“ LINK (má»—i dÃ²ng 1 má»¥c â€” há»— trá»£ text láº«n chá»¯ Trung)</span>
    <textarea id="linkin" placeholder="ã€å†¥æ²³ï¼ˆäººè¯¡ç–‘äº‘ï¼‰ç¬¬ä¹é›† æ­»äº¡ åŠ¨ç”»ã€‘ https://www.bilibili.com/video/BV1EzGiz1ETU/
https://www.douyin.com/video/7321234567890
https://b23.tv/aBcDe
..."></textarea>
    <div style="font-size:9px;color:var(--muted);margin-top:5px;font-family:'Noto Sans SC',sans-serif">âš¡ Tá»± Ä‘á»™ng loáº¡i bá» chá»¯ Trung/kÃ½ tá»±, chá»‰ giá»¯ URL há»£p lá»‡</div>
  </div>

  <div class="card">
    <div class="opts">
      <div class="og">
        <label>CHáº¤T LÆ¯á»¢NG VIDEO</label>
        <select id="qsel">
          <option value="max">ğŸ† Cao nháº¥t</option>
          <option value="1080">ğŸ¬ 1080p</option>
          <option value="720">ğŸ“º 720p</option>
          <option value="480">ğŸ“± 480p</option>
          <option value="360">ğŸ’¾ 360p</option>
        </select>
      </div>
      <div class="og">
        <label>AUDIO FORMAT</label>
        <select id="afmt">
          <option value="mp3">MP3</option>
          <option value="ogg">OGG</option>
          <option value="wav">WAV</option>
          <option value="opus">OPUS</option>
          <option value="best">Best</option>
        </select>
      </div>
      <div class="og">
        <label>COBALT API SERVER</label>
        <select id="apisel" onchange="onApiChange()">
          <option value="https://api.cobalt.tools">api.cobalt.tools (chÃ­nh thá»©c)</option>
          <option value="https://cobalt.api.timelessnesses.me">timelessnesses.me</option>
          <option value="https://cobalt.ggtyler.dev">ggtyler.dev</option>
          <option value="custom">âœ TÃ¹y chá»‰nh...</option>
        </select>
      </div>
      <div class="og" id="custwrap" style="display:none">
        <label>API URL TÃ™Y CHá»ˆNH</label>
        <input type="text" id="custapi" placeholder="https://your-cobalt.com" style="width:200px">
      </div>
    </div>
  </div>

  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button class="btn bp" onclick="parseLinks()">ğŸ” PHÃ‚N TÃCH LINK</button>
    <button class="btn bs" onclick="document.getElementById('linkin').value=''">ğŸ—‘ XÃ³a</button>
    <button class="btn bs" onclick="testApi()" id="testbtn"><span id="testspin" style="display:none" class="spin"></span> ğŸ”Œ Kiá»ƒm tra API</button>
  </div>
</div>

<!-- â•â•â• TAB DANH SÃCH â•â•â• -->
<div class="tab-pane" id="tab-queue">
  <div class="stats">
    <span class="stat"><span class="dot da"></span><span id="st-t">0</span> tá»•ng</span>
    <span class="stat"><span class="dot ds"></span><span id="st-s">0</span> Ä‘Ã£ chá»n</span>
    <span class="stat"><span class="dot dd"></span><span id="st-d">0</span> xong</span>
    <span class="stat"><span class="dot de"></span><span id="st-e">0</span> lá»—i</span>
  </div>

  <div class="tb">
    <label class="ck" style="font-size:10px;display:flex;align-items:center;gap:6px;cursor:pointer">
      <input type="checkbox" id="chkall" onchange="toggleAll(this)">
      <span class="ck-box" id="allbox">â˜</span>
      <span>Chá»n táº¥t cáº£</span>
    </label>
    <div style="flex:1"></div>
    <span style="font-size:9px;color:var(--muted)">Táº£i CHá»ŒN:</span>
    <button class="btn bv sm" id="bsv" onclick="batch('video','cobalt')" disabled>ğŸŒğŸ“¹ VIDEO</button>
    <button class="btn ba sm" id="bsa" onclick="batch('audio','cobalt')" disabled>ğŸŒğŸµ AUDIO</button>
    <button class="btn byt sm" id="bsvyt" onclick="batchYtdlp('video')" disabled>âš™ğŸ“¹ yt-dlp</button>
    <button class="btn byta sm" id="bsayt" onclick="batchYtdlp('audio')" disabled>âš™ğŸµ yt-dlp</button>
    <button class="btn bs sm" onclick="batch('all','cobalt')">ğŸ“¦ Táº¤T Cáº¢</button>
    <button class="btn bd sm" onclick="clearQ()">ğŸ—‘ XÃ³a</button>
  </div>

  <div id="vwrap">
    <div class="empty"><div class="ico">ğŸ“­</div><p>ChÆ°a cÃ³ link nÃ o â€” nháº­p link á»Ÿ tab NHáº¬P LINK</p></div>
  </div>
  <div class="logbox" id="logbox"></div>
</div>

<!-- â•â•â• TAB HÆ¯á»šNG DáºªN â•â•â• -->
<div class="tab-pane" id="tab-guide">
  <div class="card" style="line-height:1.8">
    <div class="gs">
      <h4>â‘  CÃCH Táº¢I TRá»°C TIáº¾P (file HTML nÃ y)</h4>
      <p>DÃ¹ng <b>Cobalt.tools</b> â€” API mÃ£ nguá»“n má»Ÿ. Nháº­p link â†’ nháº¥n nÃºt táº£i â†’ file tá»± download vá» mÃ¡y, khÃ´ng cáº§n cÃ i gÃ¬.</p>
    </div>
    <div class="gs">
      <h4>â‘¡ 3 NÃšT Táº¢I</h4>
      <p>
        <b style="color:var(--accent)">ğŸ“¹ VIDEO+Ã‚M</b> â€” Video Ä‘áº§y Ä‘á»§ cÃ³ Ã¢m thanh (mp4)<br>
        <b style="color:var(--green)">ğŸµ CHá»ˆ AUDIO</b> â€” Chá»‰ Ã¢m thanh (mp3/ogg/wav...)<br>
        <b style="color:var(--a3)">ğŸ–¼ áº¢NH</b> â€” Thumbnail/áº£nh bÃ¬a video
      </p>
    </div>
    <div class="gs">
      <h4>â‘¢ Náº¾U Bá»Š CHáº¶N / Lá»–I API</h4>
      <p>Äá»•i sang API server khÃ¡c trong pháº§n "COBALT API SERVER". Hoáº·c tá»± host:</p>
      <code class="blk">docker run -p 9000:9000 ghcr.io/imputnet/cobalt:10</code>
    </div>
    <div class="gs">
      <h4>â‘£ Lá»ŒC LINK Tá»° Äá»˜NG</h4>
      <code class="blk">ã€å†¥æ²³ç¬¬ä¹é›†ã€‘ https://bilibili.com/video/BV1Ez...<br>â†’ Tá»± lá»c thÃ nh: https://bilibili.com/video/BV1Ez...</code>
    </div>
    <div class="gs">
      <h4>â‘¤ FILE PY â€” DÃ™NG YT-DLP (máº¡nh hÆ¡n)</h4>
      <p>File <b>bilidown.py</b> há»— trá»£ 2 cháº¿ Ä‘á»™: táº£i báº±ng lá»‡nh yt-dlp hoáº·c táº£i trá»±c tiáº¿p qua Cobalt API.</p>
      <code class="blk">pip install yt-dlp Pillow requests<br>python bilidown.py</code>
    </div>
    <div class="gs">
      <h4>â‘¥ YT-DLP Lá»†NH THá»¦ CÃ”NG</h4>
      <code class="blk"># Video 1080p + thumbnail:<br>yt-dlp -f "bestvideo[height&lt;=1080]+bestaudio" --write-thumbnail -o "%(title)s.%(ext)s" [URL]<br><br># Chá»‰ audio MP3:<br>yt-dlp -x --audio-format mp3 [URL]<br><br># HÃ ng loáº¡t:<br>yt-dlp -f "bestvideo+bestaudio" -a links.txt -o "%(title)s.%(ext)s"</code>
    </div>
  </div>
</div>

</div><!-- /w -->

<!-- MODAL -->
<div class="mov" id="mov">
  <div class="modal">
    <button class="mc" onclick="closeMod()">âœ•</button>
    <h3 id="mtitle">CHI TIáº¾T</h3>
    <img id="mthumb" src="" alt="" style="display:none" onerror="this.style.display='none'">
    <div class="minfo" id="minfo"></div>
    <div class="dlp" id="dlp">
      <div id="dllabel" style="font-size:9px;color:var(--muted)">Äang táº£i...</div>
      <div class="dlbar"><div class="dlfill" id="dlfill"></div></div>
      <div class="dlstat" id="dlstat"></div>
    </div>
    <div class="macts" id="macts"></div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const URL_RE = /https?:\/\/(?:(?:www\.)?bilibili\.com\/video\/[A-Za-z0-9_/?=&%#.\-]+|b23\.tv\/[A-Za-z0-9]+|(?:www\.)?douyin\.com\/video\/\d+|v\.douyin\.com\/[A-Za-z0-9]+|vm\.tiktok\.com\/[A-Za-z0-9]+)[^\s\u4e00-\u9fff"'<>]*/g;
let Q = [], SEL = new Set();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function getPlatform(u){return(u.includes('bilibili.com')||u.includes('b23.tv'))?'bilibili':'douyin'}
function getID(u){const m=u.match(/\/(BV[A-Za-z0-9]+)/)||u.match(/\/video\/(\d+)/);return m?m[1]:u.slice(-10)}
function getApiBase(){const v=document.getElementById('apisel').value;return v==='custom'?document.getElementById('custapi').value.trim().replace(/\/$/,''):v}
function onApiChange(){document.getElementById('custwrap').style.display=document.getElementById('apisel').value==='custom'?'flex':'none'}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PARSE LINKS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function parseLinks(){
  const raw=document.getElementById('linkin').value.trim();
  if(!raw){log('w','ChÆ°a nháº­p link');return}
  const urls=(raw.match(URL_RE)||[]).map(u=>u.replace(/[.,!?;ï¼Œã€‚ï¼ï¼Ÿï¼›\])}]+$/,'')).filter((u,i,a)=>a.indexOf(u)===i);
  if(!urls.length){log('e','KhÃ´ng tÃ¬m tháº¥y link Bilibili/Douyin há»£p lá»‡');return}
  const exist=new Set(Q.map(v=>v.url));
  let added=0;
  const q=document.getElementById('qsel').value, af=document.getElementById('afmt').value;
  urls.forEach(url=>{
    if(exist.has(url)){log('w','ÄÃ£ tá»“n táº¡i: '+url.slice(0,55));return}
    const id='v'+Date.now()+'_'+Math.random().toString(36).slice(2,5);
    const platform=getPlatform(url), sid=getID(url);
    Q.push({id,url,platform,sid,title:`[${platform.toUpperCase()}] ${sid}`,status:'wait',thumb:null,quality:q,audioFmt:af,progress:0});
    exist.add(url); added++;
  });
  log('i',`TÃ¬m ${urls.length} link, thÃªm ${added} má»¥c`);
  renderList(); sw('queue');
  Q.filter(v=>v.status==='wait'&&v.title.startsWith('[')).forEach(v=>fetchThumb(v));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THUMBNAIL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fetchThumb(item){
  fetch(`https://noembed.com/embed?url=${encodeURIComponent(item.url)}`,{signal:AbortSignal.timeout(8000)})
    .then(r=>r.json()).then(d=>{
      if(d.thumbnail_url)item.thumb=d.thumbnail_url;
      if(d.title&&d.title!=='undefined')item.title=d.title;
      refreshItem(item.id);
    }).catch(()=>{});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderList(){
  const w=document.getElementById('vwrap');
  if(!Q.length){w.innerHTML='<div class="empty"><div class="ico">ğŸ“­</div><p>ChÆ°a cÃ³ link nÃ o</p></div>';updateStats();return}
  w.innerHTML=`<div class="vlh"><span style="width:20px">â˜‘</span><span style="width:68px">THUMB</span><span style="width:68px">Ná»€N</span><span style="flex:1">TÃŠN VIDEO</span><span style="width:220px;text-align:right">THAO TÃC</span></div><div class="vlist" id="vlist"></div>`;
  Q.forEach(v=>document.getElementById('vlist').appendChild(makeVI(v)));
  updateStats();
}

function makeVI(v){
  const el=document.createElement('div');
  const sc={wait:'',loading:'loading',done:'done',error:'error'}[v.status]||'';
  el.className=`vi ${sc} ${SEL.has(v.id)?'sel':''}`;
  el.id=`vi_${v.id}`;
  const th=v.thumb?`<img src="${esc(v.thumb)}" alt="" onerror="this.parentElement.innerHTML='ğŸ“º'"><div class="pov">â–¶</div>`:(v.platform==='bilibili'?'ğŸ“º':'ğŸ“±');
  const st={wait:'<span class="vstat sw">CHá»œTáº¢I</span>',loading:'<span class="vstat sl">â¬‡Táº¢I</span>',done:'<span class="vstat sd">âœ“XONG</span>',error:'<span class="vstat se">âœ—Lá»–I</span>'}[v.status]||'';
  el.innerHTML=`
    <label class="ck" onclick="event.stopPropagation()">
      <input type="checkbox" ${SEL.has(v.id)?'checked':''} onchange="togVI('${v.id}',this.checked)">
      <span class="ck-box">${SEL.has(v.id)?'âœ“':'â˜'}</span>
    </label>
    <div class="vthumb" onclick="showDet('${v.id}')">${th}</div>
    <div style="width:68px;flex-shrink:0"><span class="badge ${v.platform==='bilibili'?'bbili':'bdy'}">${v.platform.toUpperCase()}</span></div>
    <div class="vinfo" onclick="showDet('${v.id}')">
      <div class="vtitle">${esc(v.title)}</div>
      <div class="vurl">${esc(v.url)}</div>
      <div class="vmeta">
        <span class="badge bq">${v.quality==='max'?'BEST':v.quality+'p'}</span>
        ${v.status==='done'?'<span class="badge bok">âœ“XONG</span>':''}
      </div>
      <div class="pw"><div class="pb" id="pb_${v.id}" style="width:${v.progress}%"></div></div>
    </div>
    <div class="vacts">
      <button class="btn bv sm" onclick="event.stopPropagation();dlOne('${v.id}','video')" title="Táº£i video qua Cobalt (trá»±c tiáº¿p)">ğŸŒğŸ“¹ VIDEO</button>
      <button class="btn ba sm" onclick="event.stopPropagation();dlOne('${v.id}','audio')" title="Táº£i audio qua Cobalt (trá»±c tiáº¿p)">ğŸŒğŸµ AUDIO</button>
      <button class="btn byt sm" onclick="event.stopPropagation();openYtdlp('${v.id}','video')" title="Lá»‡nh yt-dlp cho video">âš™ğŸ“¹ yt-dlp</button>
      <button class="btn byta sm" onclick="event.stopPropagation();openYtdlp('${v.id}','audio')" title="Lá»‡nh yt-dlp cho audio">âš™ğŸµ yt-dlp</button>
      <button class="btn bi sm" onclick="event.stopPropagation();dlThumb('${v.id}')" title="Táº£i áº£nh thumbnail" ${!v.thumb?'disabled':''}>ğŸ–¼ áº¢NH</button>
    </div>
    ${st}`;
  return el;
}

function refreshItem(id){
  const v=Q.find(x=>x.id===id); if(!v)return;
  const el=document.getElementById(`vi_${id}`); if(!el)return;
  el.replaceWith(makeVI(v)); updateStats();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SELECT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function togVI(id,c){
  c?SEL.add(id):SEL.delete(id);
  const el=document.getElementById(`vi_${id}`);
  if(el){el.classList.toggle('sel',c);const b=el.querySelector('.ck-box');if(b)b.textContent=c?'âœ“':'â˜'}
  updateStats(); updSelBtns();
}
function toggleAll(cb){
  cb.checked?Q.forEach(v=>SEL.add(v.id)):SEL.clear();
  document.getElementById('allbox').textContent=cb.checked?'âœ“':'â˜';
  Q.forEach(v=>{const el=document.getElementById(`vi_${v.id}`);if(el){el.classList.toggle('sel',cb.checked);const b=el.querySelector('.ck-box');if(b)b.textContent=cb.checked?'âœ“':'â˜';const i=el.querySelector('input[type=checkbox]');if(i)i.checked=cb.checked}});
  updateStats(); updSelBtns();
}
function updSelBtns(){const d=SEL.size===0;['bsv','bsa','bsvyt','bsayt'].forEach(id=>{const el=document.getElementById(id);if(el)el.disabled=d;})}
function updateStats(){
  document.getElementById('st-t').textContent=Q.length;
  document.getElementById('st-s').textContent=SEL.size;
  document.getElementById('st-d').textContent=Q.filter(v=>v.status==='done').length;
  document.getElementById('st-e').textContent=Q.filter(v=>v.status==='error').length;
  document.getElementById('qc').textContent=Q.length;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COBALT API
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// Cobalt servers fallback list
const COBALT_SERVERS=['https://api.cobalt.tools','https://cobalt.api.timelessnesses.me','https://cobalt.ggtyler.dev'];

async function cobaltTry(base,url,type,af,q){
  const body={url,downloadMode:type==='audio'?'audio':'auto',audioFormat:af||'mp3',filenameStyle:'basic',twitterGif:false,youtubeVideoCodec:'h264'};
  if(q&&q!=='max'){body.videoQuality=q;}
  log('i','  Server: '+base);
  const res=await fetch(base+'/',{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify(body),signal:AbortSignal.timeout(20000)});
  log('i','  HTTP '+res.status);
  if(!res.ok){
    let et='';try{const ed=await res.clone().json();et=JSON.stringify(ed);}catch(e){try{et=await res.text();}catch(e2){}}
    throw new Error('HTTP '+res.status+': '+et.slice(0,100));
  }
  const data=await res.json();
  if(data.status==='error'){const c=typeof data.error==='object'?(data.error?.code||JSON.stringify(data.error)):String(data.error||'unknown');throw new Error('Cobalt: '+c);}
  const dlUrl=data.url||(Array.isArray(data.picker)&&data.picker[0]?.url)||null;
  if(!dlUrl)throw new Error('Khong co URL: '+JSON.stringify(data).slice(0,100));
  return dlUrl;
}

async function cobalt(url,type){
  const af=document.getElementById('afmt').value;
  const q=document.getElementById('qsel').value;
  const preferred=getApiBase();
  const servers=[preferred,...COBALT_SERVERS.filter(s=>s!==preferred)];
  let lastErr='';
  for(const srv of servers){
    try{const u=await cobaltTry(srv,url,type,af,q);log('o','  OK: '+srv);return u;}
    catch(e){lastErr=e.message;log('w','  FAIL '+srv+': '+lastErr);}
  }
  throw new Error('Tat ca server that bai. Cuoi: '+lastErr);
}

async function downloadBlob(url,filename,vid){
  try{
    const res=await fetch(url,{signal:AbortSignal.timeout(180000)});
    if(!res.ok)throw new Error('HTTP '+res.status);
    const total=parseInt(res.headers.get('content-length')||'0');
    const reader=res.body.getReader();
    const chunks=[]; let got=0;
    while(true){
      const{done,value}=await reader.read(); if(done)break;
      chunks.push(value); got+=value.length;
      const pct=total?Math.round(got/total*100):-1;
      if(vid){const v=Q.find(x=>x.id===vid);if(v){v.progress=pct<0?50:pct;const pb=document.getElementById(`pb_${vid}`);if(pb)pb.style.width=(pct<0?50:pct)+'%'}}
      updateDLP(pct,`${(got/1048576).toFixed(1)}MB${total?` / ${(total/1048576).toFixed(1)}MB`:''}`);
    }
    const blob=new Blob(chunks);
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download=filename;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    setTimeout(()=>URL.revokeObjectURL(a.href),8000);
    log('o',`âœ“ Táº£i xong: ${filename}`); return true;
  }catch(e){
    log('w',`Fallback link: ${e.message}`);
    const a=document.createElement('a'); a.href=url; a.download=filename; a.target='_blank';
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    return false;
  }
}

async function dlOne(id,type){
  const v=Q.find(x=>x.id===id); if(!v)return;
  v.status='loading'; v.progress=5; refreshItem(id);
  log('i',`Xá»­ lÃ½: ${v.title.slice(0,50)}`);
  showDLP();
  try{
    const dlUrl=await cobalt(v.url,type);
    v.progress=50; refreshItem(id);
    const ext=type==='audio'?document.getElementById('afmt').value:'mp4';
    const fname=(v.title||v.sid).replace(/[/\\?%*:|"<>]/g,'_').slice(0,80)+'.'+ext;
    await downloadBlob(dlUrl,fname,id);
    v.status='done'; v.progress=100;
  }catch(e){
    v.status='error'; v.progress=0;
    log('e','Loi ['+v.sid+']: '+e.message);
  }
  refreshItem(id); hideDLP();
}

// â”€â”€â”€â”€â”€â”€â”€â”€ YT-DLP COMMAND MODAL â”€â”€â”€â”€â”€â”€â”€â”€
function openYtdlp(id, type){
  const v=Q.find(x=>x.id===id); if(!v)return;
  const q=document.getElementById('qsel').value;
  const af=document.getElementById('afmt').value;
  const qualMap={max:'bestvideo+bestaudio/best','1080':'bestvideo[height<=1080]+bestaudio/best','720':'bestvideo[height<=720]+bestaudio/best','480':'bestvideo[height<=480]+bestaudio/best','360':'bestvideo[height<=360]+bestaudio/best'};
  const fmt=qualMap[q]||'bestvideo+bestaudio/best';
  let cmd;
  if(type==='audio'){
    cmd=`yt-dlp -x --audio-format ${af} -o "%(title)s.%(ext)s" "${v.url}"`;
  } else {
    cmd=`yt-dlp -f "${fmt}" --merge-output-format mp4 --write-thumbnail -o "%(title)s.%(ext)s" "${v.url}"`;
  }
  // Show modal with command
  document.getElementById('mtitle').textContent='âš™ Lá»†NH YT-DLP â€” '+(type==='audio'?'AUDIO':'VIDEO');
  const th=document.getElementById('mthumb');
  if(v.thumb){th.src=v.thumb;th.style.display='block';}else th.style.display='none';
  document.getElementById('minfo').innerHTML=`
    <strong>Video:</strong> ${esc(v.title)}<br>
    <strong>URL:</strong> <a href="${esc(v.url)}" target="_blank" style="color:var(--accent);font-size:9px;word-break:break-all">${esc(v.url)}</a><br><br>
    <strong>Lá»‡nh yt-dlp:</strong>
    <code id="ytcmd" style="display:block;background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:10px;font-size:10px;color:var(--green);margin:8px 0;word-break:break-all;white-space:pre-wrap;font-family:monospace">${esc(cmd)}</code>
    <div style="font-size:9px;color:var(--muted);margin-top:4px;font-family:'Noto Sans SC',sans-serif">
      ğŸ’¡ Copy lá»‡nh â†’ má»Ÿ Terminal â†’ dÃ¡n vÃ o â†’ Enter Ä‘á»ƒ táº£i<br>
      ChÆ°a cÃ³ yt-dlp? Cháº¡y: <code style="color:var(--accent)">pip install yt-dlp</code>
    </div>`;
  document.getElementById('dlp').style.display='none';
  document.getElementById('macts').innerHTML=`
    <button class="btn byt" onclick="navigator.clipboard?.writeText(document.getElementById('ytcmd').textContent);log('o','ÄÃ£ copy lá»‡nh yt-dlp!')">ğŸ“‹ Copy lá»‡nh</button>
    <button class="btn bv" onclick="dlOne('${id}','${type}');closeMod()">ğŸŒ Táº£i trá»±c tiáº¿p (Cobalt)</button>
    <button class="btn bs" onclick="closeMod()">ÄÃ³ng</button>`;
  document.getElementById('mov').classList.add('open');
}

async function dlThumb(id){
  const v=Q.find(x=>x.id===id); if(!v||!v.thumb){log('w','ChÆ°a cÃ³ thumbnail');return}
  const fname=`${v.sid}_thumb.jpg`;
  log('i',`Táº£i áº£nh: ${fname}`);
  // Proxy qua fetch Ä‘á»ƒ download
  try{
    const res=await fetch(v.thumb,{signal:AbortSignal.timeout(15000)});
    const blob=await res.blob();
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fname;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    setTimeout(()=>URL.revokeObjectURL(a.href),5000);
    log('o',`âœ“ ÄÃ£ táº£i áº£nh: ${fname}`);
  }catch(e){
    const a=document.createElement('a'); a.href=v.thumb; a.target='_blank'; a.click();
    log('o','Má»Ÿ áº£nh trong tab má»›i');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BATCH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let batchRunning=false;
async function batch(type, mode){
  if(batchRunning){log('w','Dang tai, cho xong');return}
  let ids,dlType=type;
  if(type==='all'){ids=Q.map(v=>v.id);dlType='video';}
  else ids=[...SEL];
  if(!ids.length)return;
  batchRunning=true;
  log('i',`Batch [${mode||'cobalt'}]: ${ids.length} muc (${dlType})`);
  for(const id of ids){
    await dlOne(id,dlType);
    await new Promise(r=>setTimeout(r,800));
  }
  batchRunning=false;
  log('o',`Batch xong: ${ids.length} muc`);
}

async function batchYtdlp(type){
  // Show all commands at once in modal
  const ids=[...SEL];
  if(!ids.length){log('w','Chua chon video nao');return;}
  const q=document.getElementById('qsel').value;
  const af=document.getElementById('afmt').value;
  const qualMap={max:'bestvideo+bestaudio/best','1080':'bestvideo[height<=1080]+bestaudio/best','720':'bestvideo[height<=720]+bestaudio/best','480':'bestvideo[height<=480]+bestaudio/best','360':'bestvideo[height<=360]+bestaudio/best'};
  const fmt=qualMap[q]||'bestvideo+bestaudio/best';
  const cmds=ids.map(id=>{
    const v=Q.find(x=>x.id===id); if(!v)return'';
    if(type==='audio') return `yt-dlp -x --audio-format ${af} -o "%(title)s.%(ext)s" "${v.url}"`;
    return `yt-dlp -f "${fmt}" --merge-output-format mp4 --write-thumbnail -o "%(title)s.%(ext)s" "${v.url}"`;
  }).filter(Boolean).join('\n');
  document.getElementById('mtitle').textContent=`âš™ YT-DLP BATCH (${ids.length} video) â€” ${type.toUpperCase()}`;
  document.getElementById('mthumb').style.display='none';
  document.getElementById('minfo').innerHTML=`
    <strong>${ids.length} lá»‡nh yt-dlp:</strong>
    <code id="ytcmd" style="display:block;background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:10px;font-size:9px;color:var(--green);margin:8px 0;word-break:break-all;white-space:pre-wrap;max-height:200px;overflow-y:auto;font-family:monospace">${esc(cmds)}</code>
    <div style="font-size:9px;color:var(--muted)">Hoac tao file links.txt roi chay:<br>
    <code style="color:var(--accent)">yt-dlp -a links.txt -f "${esc(fmt)}" --write-thumbnail -o "%(title)s.%(ext)s"</code></div>`;
  document.getElementById('dlp').style.display='none';
  document.getElementById('macts').innerHTML=`
    <button class="btn byt" onclick="navigator.clipboard?.writeText(document.getElementById('ytcmd').textContent);log('o','Da copy lenh!')">ğŸ“‹ Copy tat ca lenh</button>
    <button class="btn bs" onclick="closeMod()">Dong</button>`;
  document.getElementById('mov').classList.add('open');
}

function clearQ(){if(!Q.length)return;Q=[];SEL.clear();renderList();log('w','ÄÃ£ xÃ³a hÃ ng Ä‘á»£i')}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DL PROGRESS UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showDLP(){document.getElementById('dlp').style.display='block';document.getElementById('dlfill').style.width='0'}
function hideDLP(){setTimeout(()=>{document.getElementById('dlp').style.display='none'},1500)}
function updateDLP(pct,label){
  document.getElementById('dllabel').textContent=pct<0?'Äang táº£i...':'Äang táº£i: '+pct+'%';
  document.getElementById('dlfill').style.width=(pct<0?'60':pct)+'%';
  document.getElementById('dlstat').textContent=label;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DETAIL MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showDet(id){
  const v=Q.find(x=>x.id===id); if(!v)return;
  document.getElementById('mtitle').textContent='ğŸ“¹ CHI TIáº¾T VIDEO';
  const th=document.getElementById('mthumb');
  if(v.thumb){th.src=v.thumb;th.style.display='block'}else th.style.display='none';
  document.getElementById('minfo').innerHTML=`
    <strong>TÃªn:</strong> ${esc(v.title)}<br>
    <strong>Platform:</strong> ${v.platform.toUpperCase()}<br>
    <strong>ID:</strong> ${v.sid}<br>
    <strong>Cháº¥t lÆ°á»£ng:</strong> ${v.quality==='max'?'Cao nháº¥t':v.quality+'p'}<br>
    <strong>URL:</strong><br>
    <a href="${esc(v.url)}" target="_blank" style="color:var(--accent);font-size:9px;word-break:break-all">${esc(v.url)}</a>`;
  document.getElementById('dlp').style.display='none';
  document.getElementById('macts').innerHTML=`
    <button class="btn bv" onclick="dlOne('${id}','video');closeMod()">ğŸ“¹ VIDEO+Ã‚M</button>
    <button class="btn ba" onclick="dlOne('${id}','audio');closeMod()">ğŸµ CHá»ˆ AUDIO</button>
    ${v.thumb?`<button class="btn bi" onclick="dlThumb('${id}');closeMod()">ğŸ–¼ Táº¢I áº¢NH</button>`:''}
    <button class="btn bs" onclick="navigator.clipboard?.writeText('${esc(v.url)}');log('o','ÄÃ£ copy URL!')">ğŸ“‹ Copy URL</button>
    <button class="btn bs" onclick="closeMod()">ÄÃ³ng</button>`;
  document.getElementById('mov').classList.add('open');
}
function closeMod(){document.getElementById('mov').classList.remove('open')}
document.getElementById('mov').addEventListener('click',e=>{if(e.target===document.getElementById('mov'))closeMod()});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API TEST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function testApi(){
  const dot=document.getElementById('api-dot'),sp=document.getElementById('testspin');
  dot.className='api-dot chk';dot.textContent='â— Äang kiá»ƒm tra...';sp.style.display='inline-block';
  try{
    const base=getApiBase();
    const res=await fetch(`${base}/`,{method:'POST',signal:AbortSignal.timeout(10000),headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify({url:'https://www.bilibili.com/video/BV1xx411c7mD'})});
    // 400/422 = server up but invalid URL = OK
    const ok=res.ok||res.status===400||res.status===422;
    dot.className='api-dot '+(ok?'ok':'err');
    dot.textContent=ok?'â— API: Online âœ“':`â— API: Lá»—i ${res.status}`;
    log(ok?'o':'e',ok?'Cobalt API hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng':'API khÃ´ng pháº£n há»“i Ä‘Ãºng: HTTP '+res.status);
  }catch(e){
    dot.className='api-dot err';dot.textContent='â— API: Offline âœ—';
    log('e','KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c API. Thá»­ server khÃ¡c hoáº·c kiá»ƒm tra máº¡ng.');
  }finally{sp.style.display='none'}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function log(type,msg){
  const b=document.getElementById('logbox'); if(!b)return;
  const d=document.createElement('div');
  d.className='ll l'+type;
  d.textContent=`[${new Date().toLocaleTimeString('vi-VN')}] ${msg}`;
  b.appendChild(d); b.scrollTop=b.scrollHeight;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function sw(name){
  document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  const m={input:0,queue:1,guide:2};
  document.querySelectorAll('.tab')[m[name]].classList.add('active');
}

/* INIT */
window.addEventListener('load',()=>{
  log('i','BiliDown sáºµn sÃ ng â€” Nháº­p link vÃ  nháº¥n PhÃ¢n TÃ­ch Link');
  setTimeout(testApi,600);
});
</script>
</body>
</html>