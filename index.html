<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BiliDown ‚Äî T·∫£i Video Bilibili & Douyin</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --panel: #111118;
    --border: #1e1e2e;
    --accent: #00e5ff;
    --accent2: #ff3d6b;
    --accent3: #7b61ff;
    --text: #e0e0f0;
    --muted: #555570;
    --success: #00e676;
    --warn: #ffb300;
    --card: #14141f;
    --card-hover: #1a1a2a;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Space Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }
  /* Background grid */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,229,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container { max-width: 980px; margin: 0 auto; padding: 0 20px; position: relative; z-index: 1; }

  /* HEADER */
  header {
    padding: 28px 0 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 14px;
  }
  .logo-icon {
    width: 42px; height: 42px;
    background: linear-gradient(135deg, var(--accent), var(--accent3));
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
  }
  header h1 { font-size: 22px; letter-spacing: 2px; color: var(--accent); }
  header p { font-size: 11px; color: var(--muted); margin-top: 3px; font-family: 'Noto Sans SC', sans-serif; }
  .platform-tags { margin-left: auto; display: flex; gap: 8px; }
  .ptag {
    padding: 4px 10px; border-radius: 4px; font-size: 10px; letter-spacing: 1px;
    border: 1px solid;
  }
  .ptag.bili { color: #00b5e2; border-color: #00b5e2; background: rgba(0,181,226,0.08); }
  .ptag.dy { color: var(--accent2); border-color: var(--accent2); background: rgba(255,61,107,0.08); }

  /* TABS */
  .tabs { display: flex; gap: 0; margin: 24px 0 0; border-bottom: 1px solid var(--border); }
  .tab {
    padding: 10px 20px; font-size: 12px; letter-spacing: 1px; cursor: pointer;
    color: var(--muted); border-bottom: 2px solid transparent; transition: all 0.2s;
    background: none; border-top: none; border-left: none; border-right: none; font-family: 'Space Mono', monospace;
  }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab:hover:not(.active) { color: var(--text); }

  /* TAB CONTENT */
  .tab-content { display: none; padding: 20px 0; }
  .tab-content.active { display: block; }

  /* INPUT AREA */
  .input-section {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 18px;
    margin-bottom: 18px;
  }
  .input-section label { font-size: 11px; color: var(--muted); letter-spacing: 1px; display: block; margin-bottom: 8px; }
  .input-section textarea, .input-section input[type=text] {
    width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text);
    font-family: 'Space Mono', monospace; font-size: 12px; border-radius: 6px;
    padding: 10px 12px; resize: vertical; outline: none; transition: border-color 0.2s;
  }
  textarea { height: 110px; }
  .input-section textarea:focus, .input-section input:focus { border-color: var(--accent); }
  .hint { font-size: 10px; color: var(--muted); margin-top: 6px; font-family: 'Noto Sans SC', sans-serif; }
  .hint span { color: var(--accent2); }

  /* OPTIONS ROW */
  .options-row {
    display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
    background: var(--panel); border: 1px solid var(--border); border-radius: 10px;
    padding: 14px 18px; margin-bottom: 18px;
  }
  .opt-group { display: flex; flex-direction: column; gap: 5px; min-width: 130px; }
  .opt-group label { font-size: 10px; color: var(--muted); letter-spacing: 1px; }
  select {
    background: var(--bg); border: 1px solid var(--border); color: var(--text);
    font-family: 'Space Mono', monospace; font-size: 11px; padding: 6px 10px; border-radius: 5px;
    outline: none; cursor: pointer;
  }
  select:focus { border-color: var(--accent); }

  .checkbox-group { display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none; }
  .checkbox-group input { display: none; }
  .custom-check {
    width: 16px; height: 16px; border: 1px solid var(--muted); border-radius: 3px;
    display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0;
  }
  .checkbox-group input:checked + .custom-check {
    background: var(--accent); border-color: var(--accent);
  }
  .custom-check::after { content: '‚úì'; font-size: 10px; color: var(--bg); display: none; }
  .checkbox-group input:checked + .custom-check::after { display: block; }
  .checkbox-group span { font-size: 11px; color: var(--text); }

  /* BUTTONS */
  .btn-row { display: flex; gap: 10px; flex-wrap: wrap; }
  .btn {
    padding: 10px 20px; border-radius: 6px; font-family: 'Space Mono', monospace;
    font-size: 12px; letter-spacing: 1px; cursor: pointer; border: none; transition: all 0.2s;
    display: flex; align-items: center; gap: 7px;
  }
  .btn-primary {
    background: var(--accent); color: var(--bg); font-weight: 700;
  }
  .btn-primary:hover { background: #33eeff; transform: translateY(-1px); }
  .btn-secondary {
    background: transparent; color: var(--text); border: 1px solid var(--border);
  }
  .btn-secondary:hover { border-color: var(--text); }
  .btn-danger { background: transparent; color: var(--accent2); border: 1px solid var(--accent2); }
  .btn-danger:hover { background: rgba(255,61,107,0.1); }
  .btn:active { transform: scale(0.97); }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }

  /* STATS BAR */
  .stats-bar {
    display: flex; gap: 18px; padding: 10px 0; margin-bottom: 14px;
    font-size: 11px; flex-wrap: wrap;
  }
  .stat { display: flex; align-items: center; gap: 5px; }
  .stat-dot { width: 7px; height: 7px; border-radius: 50%; }
  .stat-dot.all { background: var(--muted); }
  .stat-dot.checked { background: var(--accent); }
  .stat-dot.done { background: var(--success); }
  .stat-dot.error { background: var(--accent2); }

  /* VIDEO LIST */
  .video-list-header {
    display: flex; align-items: center; gap: 10px; padding: 10px 14px;
    background: var(--panel); border: 1px solid var(--border); border-radius: 8px 8px 0 0;
    font-size: 11px; color: var(--muted);
  }
  .video-list { border: 1px solid var(--border); border-top: none; border-radius: 0 0 8px 8px; overflow: hidden; }
  .video-item {
    display: flex; align-items: center; gap: 12px;
    padding: 10px 14px;
    background: var(--card);
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
    cursor: pointer;
  }
  .video-item:last-child { border-bottom: none; }
  .video-item:hover { background: var(--card-hover); }
  .video-item.selected { background: rgba(0,229,255,0.05); border-left: 3px solid var(--accent); }
  .video-item.downloading { border-left: 3px solid var(--warn); }
  .video-item.done { border-left: 3px solid var(--success); }
  .video-item.error { border-left: 3px solid var(--accent2); }

  .vi-check { flex-shrink: 0; }
  .vi-thumb {
    width: 72px; height: 45px; border-radius: 4px; object-fit: cover;
    background: var(--border); flex-shrink: 0; border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center; font-size: 18px; overflow: hidden;
  }
  .vi-thumb img { width: 100%; height: 100%; object-fit: cover; }
  .vi-info { flex: 1; min-width: 0; }
  .vi-title { font-size: 12px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-family: 'Noto Sans SC', sans-serif; }
  .vi-url { font-size: 10px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .vi-meta { display: flex; gap: 8px; margin-top: 3px; }
  .vi-badge {
    font-size: 9px; padding: 1px 6px; border-radius: 3px; letter-spacing: 0.5px;
  }
  .badge-bili { background: rgba(0,181,226,0.15); color: #00b5e2; }
  .badge-dy { background: rgba(255,61,107,0.15); color: var(--accent2); }
  .badge-type { background: rgba(123,97,255,0.15); color: var(--accent3); }

  .vi-actions { display: flex; gap: 6px; flex-shrink: 0; }
  .vi-btn {
    padding: 4px 10px; border-radius: 4px; font-size: 10px; cursor: pointer;
    border: 1px solid; background: transparent; font-family: 'Space Mono', monospace;
    transition: all 0.15s; letter-spacing: 0.5px;
  }
  .vi-btn.video { color: var(--accent); border-color: var(--accent); }
  .vi-btn.video:hover { background: rgba(0,229,255,0.1); }
  .vi-btn.image { color: var(--accent3); border-color: var(--accent3); }
  .vi-btn.image:hover { background: rgba(123,97,255,0.1); }
  .vi-btn:disabled { opacity: 0.3; cursor: not-allowed; }

  .vi-status {
    font-size: 9px; letter-spacing: 1px; flex-shrink: 0; min-width: 60px; text-align: right;
    font-family: 'Space Mono', monospace;
  }
  .status-waiting { color: var(--muted); }
  .status-loading { color: var(--warn); }
  .status-done { color: var(--success); }
  .status-error { color: var(--accent2); }

  /* PROGRESS */
  .progress-bar-wrap { height: 2px; background: var(--border); border-radius: 1px; margin-top: 4px; display: none; }
  .progress-bar { height: 100%; background: var(--accent); border-radius: 1px; transition: width 0.3s; width: 0%; }
  .video-item.downloading .progress-bar-wrap { display: block; }

  /* EMPTY STATE */
  .empty-state {
    padding: 60px 20px; text-align: center; color: var(--muted);
    font-family: 'Noto Sans SC', sans-serif;
  }
  .empty-state .icon { font-size: 42px; margin-bottom: 12px; }
  .empty-state p { font-size: 13px; }
  .empty-state small { font-size: 11px; color: var(--border); margin-top: 6px; display: block; }

  /* LOG */
  .log-area {
    background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
    padding: 12px; font-size: 10px; height: 120px; overflow-y: auto;
    font-family: 'Space Mono', monospace; color: var(--muted); margin-top: 16px;
  }
  .log-area .log-line { padding: 1px 0; }
  .log-area .log-info { color: var(--accent); }
  .log-area .log-ok { color: var(--success); }
  .log-area .log-err { color: var(--accent2); }
  .log-area .log-warn { color: var(--warn); }

  /* MODAL */
  .modal-overlay {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8);
    z-index: 100; align-items: center; justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--panel); border: 1px solid var(--border); border-radius: 12px;
    padding: 24px; width: 400px; max-width: 95vw;
  }
  .modal h3 { font-size: 14px; color: var(--accent); margin-bottom: 14px; letter-spacing: 1px; }
  .modal img { width: 100%; border-radius: 6px; margin-bottom: 12px; }
  .modal .close-btn { float: right; font-size: 18px; cursor: pointer; color: var(--muted); background: none; border: none; }
  .modal .close-btn:hover { color: var(--text); }
  .modal-info { font-size: 11px; color: var(--muted); line-height: 1.7; font-family: 'Noto Sans SC', sans-serif; }
  .modal-info strong { color: var(--text); }

  /* NOTICE */
  .notice {
    background: rgba(255,179,0,0.07); border: 1px solid rgba(255,179,0,0.2);
    border-radius: 8px; padding: 12px 16px; font-size: 11px; color: var(--warn);
    margin-bottom: 16px; font-family: 'Noto Sans SC', sans-serif; line-height: 1.6;
  }
  .notice strong { display: block; margin-bottom: 4px; }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 4px; height: 4px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

  /* LOADING SPINNER */
  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner {
    width: 12px; height: 12px; border: 2px solid transparent;
    border-top-color: var(--accent); border-radius: 50%;
    animation: spin 0.7s linear infinite; display: inline-block;
  }

  @keyframes fadeIn { from { opacity:0; transform:translateY(6px);} to { opacity:1; transform:none; } }
  .video-item { animation: fadeIn 0.2s ease; }

  .select-all-label { font-size: 11px; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 6px; }
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo-icon">‚¨á</div>
    <div>
      <h1>BILIDOWN</h1>
      <p>C√¥ng c·ª• t·∫£i video Bilibili & Douyin ‚Äî H·ªó tr·ª£ h√†ng lo·∫°t</p>
    </div>
    <div class="platform-tags">
      <span class="ptag bili">BILIBILI</span>
      <span class="ptag dy">DOUYIN</span>
    </div>
  </header>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('input')">üì• NH·∫¨P LINK</button>
    <button class="tab" onclick="switchTab('queue')">üìã DANH S√ÅCH (<span id="queue-count">0</span>)</button>
    <button class="tab" onclick="switchTab('guide')">üìñ H∆Ø·ªöNG D·∫™N</button>
  </div>

  <!-- TAB NH·∫¨P LINK -->
  <div class="tab-content active" id="tab-input">
    <div class="notice">
      <strong>‚ö° L∆∞u √Ω quan tr·ªçng</strong>
      Tool s·∫Ω tr√≠ch xu·∫•t link thu·∫ßn t·ª´ text c√≥ k√®m ch·ªØ. V√≠ d·ª•:<br>
      <code style="color:#00e5ff">„ÄêÂÜ•Ê≤≥Á¨¨‰πùÈõÜ„Äë https://www.bilibili.com/video/BV1Ez...</code><br>
      ‚Üí T·ª± ƒë·ªông l·ªçc th√†nh: <code style="color:#00e676">https://www.bilibili.com/video/BV1Ez...</code>
    </div>

    <div class="input-section">
      <label>D√ÅN LINK / TEXT C√ì LINK (m·ªói d√≤ng 1 link, h·ªó tr·ª£ text l·∫´n link)</label>
      <textarea id="link-input" placeholder="D√°n nhi·ªÅu link t·∫°i ƒë√¢y, m·ªói d√≤ng 1 link.
V√≠ d·ª•:
„ÄêÂÜ•Ê≤≥Ôºà‰∫∫ËØ°Áñë‰∫ëÔºâÁ¨¨‰πùÈõÜ„Äë https://www.bilibili.com/video/BV1EzGiz1ETU/
https://www.douyin.com/video/7321234567890
https://b23.tv/aBcDe
..."></textarea>
      <div class="hint">
        Tool t·ª± ƒë·ªông <span>lo·∫°i b·ªè ch·ªØ c√°i/k√Ω t·ª±</span> kh√¥ng ph·∫£i link ‚Äî ch·ªâ gi·ªØ l·∫°i URL h·ª£p l·ªá c·ªßa Bilibili & Douyin.
      </div>
    </div>

    <div class="options-row">
      <div class="opt-group">
        <label>CH·∫§T L∆Ø·ª¢NG VIDEO</label>
        <select id="quality-select">
          <option value="best">üèÜ Cao nh·∫•t (Best)</option>
          <option value="1080p">üé¨ 1080p Full HD</option>
          <option value="720p">üì∫ 720p HD</option>
          <option value="480p">üì± 480p</option>
          <option value="360p">üíæ 360p</option>
        </select>
      </div>
      <div class="opt-group">
        <label>ƒê·ªäNH D·∫†NG</label>
        <select id="format-select">
          <option value="mp4">MP4</option>
          <option value="mkv">MKV</option>
          <option value="webm">WebM</option>
        </select>
      </div>
      <div style="flex:1; display:flex; gap:16px; flex-wrap:wrap; align-items:center;">
        <label class="checkbox-group">
          <input type="checkbox" id="dl-video" checked>
          <span class="custom-check"></span>
          <span>T·∫£i Video</span>
        </label>
        <label class="checkbox-group">
          <input type="checkbox" id="dl-thumb" checked>
          <span class="custom-check"></span>
          <span>T·∫£i ·∫¢nh Thumbnail</span>
        </label>
        <label class="checkbox-group">
          <input type="checkbox" id="dl-audio">
          <span class="custom-check"></span>
          <span>Ch·ªâ Audio</span>
        </label>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" onclick="parseLinks()">
        <span>üîç</span> PH√ÇN T√çCH LINK
      </button>
      <button class="btn btn-secondary" onclick="clearInput()">
        üóë X√≥a
      </button>
    </div>
  </div>

  <!-- TAB DANH S√ÅCH -->
  <div class="tab-content" id="tab-queue">
    <div class="stats-bar">
      <span class="stat"><span class="stat-dot all"></span><span id="stat-total">0</span> t·ªïng</span>
      <span class="stat"><span class="stat-dot checked"></span><span id="stat-selected">0</span> ƒë√£ ch·ªçn</span>
      <span class="stat"><span class="stat-dot done"></span><span id="stat-done">0</span> xong</span>
      <span class="stat"><span class="stat-dot error"></span><span id="stat-error">0</span> l·ªói</span>
    </div>

    <div style="display:flex; gap:10px; margin-bottom:14px; flex-wrap:wrap; align-items:center;">
      <label class="select-all-label">
        <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)">
        <span class="custom-check" id="select-all-check"></span>
        <span>Ch·ªçn t·∫•t c·∫£</span>
      </label>
      <div style="flex:1"></div>
      <button class="btn btn-primary" id="btn-download-selected" onclick="downloadSelected()" disabled>
        ‚¨á T·∫¢I NH·ªÆNG C√ÅI ƒê√É CH·ªåN
      </button>
      <button class="btn btn-secondary" onclick="downloadAll()">
        üì¶ T·∫¢I T·∫§T C·∫¢
      </button>
      <button class="btn btn-danger" onclick="clearQueue()">
        üóë X√≥a h√†ng ƒë·ª£i
      </button>
    </div>

    <div id="video-list-wrap">
      <div class="empty-state">
        <div class="icon">üì≠</div>
        <p>Ch∆∞a c√≥ link n√†o trong danh s√°ch</p>
        <small>H√£y nh·∫≠p link ·ªü tab "NH·∫¨P LINK" v√† nh·∫•n "Ph√¢n T√≠ch Link"</small>
      </div>
    </div>

    <div class="log-area" id="log-area">
      <div class="log-line log-info">// Nh·∫≠t k√Ω ho·∫°t ƒë·ªông s·∫Ω hi·ªán ·ªü ƒë√¢y...</div>
    </div>
  </div>

  <!-- TAB H∆Ø·ªöNG D·∫™N -->
  <div class="tab-content" id="tab-guide">
    <div class="input-section" style="line-height:1.9; font-family:'Noto Sans SC',sans-serif; font-size:13px;">
      <h3 style="color:var(--accent); margin-bottom:14px; font-family:'Space Mono',monospace;">üìñ H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG</h3>

      <p style="color:var(--muted); margin-bottom:16px;">Tool n√†y l√† giao di·ªán ng∆∞·ªùi d√πng ‚Äî ƒë·ªÉ t·∫£i th·ª±c t·∫ø, b·∫°n c·∫ßn c√†i <strong style="color:var(--accent)">yt-dlp</strong> ho·∫∑c plugin tr√¨nh duy·ªát. Tool s·∫Ω t·∫°o l·ªánh CLI t∆∞∆°ng ·ª©ng.</p>

      <div style="margin-bottom:18px;">
        <p style="color:var(--accent2); font-weight:700; margin-bottom:8px;">‚ë† NH·∫¨P LINK</p>
        <p>D√°n b·∫•t k·ª≥ text n√†o c√≥ ch·ª©a link Bilibili/Douyin. Tool t·ª± ƒë·ªông l·ªçc link:</p>
        <code style="display:block; background:var(--bg); padding:10px; border-radius:5px; margin:8px 0; font-size:11px; color:#00e676; border:1px solid var(--border)">
„ÄêÂÜ•Ê≤≥Á¨¨‰πùÈõÜ Ê≠ª‰∫° Âä®Áîª„Äë https://www.bilibili.com/video/BV1Ez...<br>
‚Üí L·ªçc th√†nh: https://www.bilibili.com/video/BV1Ez...
        </code>
      </div>

      <div style="margin-bottom:18px;">
        <p style="color:var(--accent2); font-weight:700; margin-bottom:8px;">‚ë° CH·ªåN CH·∫§T L∆Ø·ª¢NG</p>
        <p>Ch·ªçn <strong>Cao nh·∫•t</strong> ƒë·ªÉ t·ª± ƒë·ªông l·∫•y ch·∫•t l∆∞·ª£ng t·ªët nh·∫•t, ho·∫∑c ch·ªçn 1080p/720p... tu·ª≥ nhu c·∫ßu.</p>
      </div>

      <div style="margin-bottom:18px;">
        <p style="color:var(--accent2); font-weight:700; margin-bottom:8px;">‚ë¢ T·∫¢I THUMBNAIL</p>
        <p>B·∫≠t "T·∫£i ·∫¢nh Thumbnail" ƒë·ªÉ l∆∞u ·∫£nh b√¨a video ‚Äî gi√∫p nh·∫≠n di·ªán ƒë√∫ng video khi qu·∫£n l√Ω file.</p>
      </div>

      <div style="margin-bottom:18px;">
        <p style="color:var(--accent2); font-weight:700; margin-bottom:8px;">‚ë£ L·ªÜNH YT-DLP (N√ÇNG CAO)</p>
        <p>C√†i yt-dlp v√† d√πng l·ªánh sau ƒë·ªÉ t·∫£i Bilibili/Douyin:</p>
        <code style="display:block; background:var(--bg); padding:10px; border-radius:5px; margin:8px 0; font-size:10px; color:var(--accent); border:1px solid var(--border); word-break:break-all">
# T·∫£i video 1080p + thumbnail:<br>
yt-dlp -f "bestvideo[height<=1080]+bestaudio" --write-thumbnail -o "%(title)s.%(ext)s" [URL]<br><br>
# T·∫£i h√†ng lo·∫°t t·ª´ file links.txt:<br>
yt-dlp -f "bestvideo+bestaudio" --write-thumbnail -a links.txt -o "%(title)s.%(ext)s"<br><br>
# Douyin:<br>
yt-dlp --cookies-from-browser chrome [URL]
        </code>
      </div>

      <div>
        <p style="color:var(--accent2); font-weight:700; margin-bottom:8px;">‚ë§ NH·∫¨P LINK TO√ÄN B·ªò VIDEO T·ª™ K√äNH/T√ÄI KHO·∫¢N</p>
        <p>ƒê·ªÉ l·∫•y t·∫•t c·∫£ video c·ªßa 1 k√™nh Bilibili, d√°n link k√™nh v√†o √¥ nh·∫≠p li·ªáu:<br>
        <code style="font-size:11px; color:#00e5ff">https://space.bilibili.com/[UID]</code><br>
        ho·∫∑c d√πng yt-dlp: <code style="font-size:11px; color:#00e676">yt-dlp --flat-playlist https://space.bilibili.com/[UID]/video</code>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- MODAL XEM CHI TI·∫æT -->
<div class="modal-overlay" id="detail-modal">
  <div class="modal">
    <button class="close-btn" onclick="closeModal()">‚úï</button>
    <h3 id="modal-title">CHI TI·∫æT VIDEO</h3>
    <img id="modal-thumb" src="" alt="thumbnail" onerror="this.style.display='none'">
    <div class="modal-info" id="modal-info"></div>
    <div style="margin-top:14px; display:flex; gap:8px; flex-wrap:wrap;" id="modal-actions"></div>
  </div>
</div>

<script>
// State
let videoQueue = [];
let selectedIds = new Set();

// ======================== PARSING ========================
function extractUrls(text) {
  const urlRegex = /https?:\/\/(www\.)?(bilibili\.com\/video\/[A-Za-z0-9_\/?=&%#.-]+|b23\.tv\/[A-Za-z0-9]+|douyin\.com\/video\/[0-9]+|vm\.tiktok\.com\/[A-Za-z0-9]+|v\.douyin\.com\/[A-Za-z0-9]+)[^\s"]*/g;
  const matches = text.match(urlRegex) || [];
  // Clean trailing punctuation
  return [...new Set(matches.map(u => u.replace(/[.,!?;Ôºå„ÄÇÔºÅÔºüÔºõ\])}]+$/, '')))];
}

function detectPlatform(url) {
  if (url.includes('bilibili.com') || url.includes('b23.tv')) return 'bilibili';
  if (url.includes('douyin.com') || url.includes('v.douyin.com') || url.includes('vm.tiktok.com')) return 'douyin';
  return 'unknown';
}

function extractBVID(url) {
  const m = url.match(/\/(BV[A-Za-z0-9]+)/);
  return m ? m[1] : null;
}

function extractVideoTitle(url) {
  const platform = detectPlatform(url);
  const bvid = extractBVID(url);
  if (bvid) return `[Bilibili] ${bvid}`;
  const douyinMatch = url.match(/video\/(\d+)/);
  if (douyinMatch) return `[Douyin] ${douyinMatch[1]}`;
  return 'Video';
}

function parseLinks() {
  const raw = document.getElementById('link-input').value.trim();
  if (!raw) { addLog('warn', 'Ch∆∞a nh·∫≠p link n√†o.'); return; }

  const urls = extractUrls(raw);
  if (urls.length === 0) {
    addLog('err', 'Kh√¥ng t√¨m th·∫•y link Bilibili/Douyin h·ª£p l·ªá n√†o.');
    return;
  }

  let added = 0;
  const existingUrls = new Set(videoQueue.map(v => v.cleanUrl));

  urls.forEach(url => {
    const cleanUrl = url.split('?')[0]; // also keep query params but note base
    if (existingUrls.has(url)) {
      addLog('warn', `ƒê√£ c√≥: ${url.slice(0, 60)}...`);
      return;
    }
    const id = 'v_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
    const platform = detectPlatform(url);
    const title = extractVideoTitle(url);
    const bvid = extractBVID(url);

    videoQueue.push({
      id, url, cleanUrl: url, platform, title, bvid,
      status: 'waiting',
      thumb: null,
      quality: document.getElementById('quality-select').value,
      format: document.getElementById('format-select').value,
      dlVideo: document.getElementById('dl-video').checked,
      dlThumb: document.getElementById('dl-thumb').checked,
    });
    existingUrls.add(url);
    added++;
  });

  addLog('info', `Ph√¢n t√≠ch xong: t√¨m th·∫•y ${urls.length} link, th√™m ${added} v√†o h√†ng ƒë·ª£i.`);
  updateStats();
  renderVideoList();
  switchTab('queue');

  // Auto fetch thumbnails
  videoQueue.filter(v => v.status === 'waiting').forEach(v => loadThumbnail(v));
}

// ======================== THUMBNAIL ========================
function loadThumbnail(video) {
  if (video.platform === 'bilibili' && video.bvid) {
    // Use Bilibili's public API via proxy-free iframe method
    const bvid = video.bvid;
    // Try to use noembed/oembed or just show placeholder
    const thumbUrl = `https://i0.hdslb.com/bfs/archive/${bvid}_u_1.jpg`;
    video.thumb = thumbUrl;
    // Also try oEmbed
    fetchBilibiliThumb(video);
  } else if (video.platform === 'douyin') {
    video.thumb = null;
    addLog('warn', `[${video.id}] Douyin thumbnail: c·∫ßn API c√≥ auth.`);
  }
  renderVideoItem(video.id);
}

function fetchBilibiliThumb(video) {
  // Try noembed
  const oembedUrl = `https://noembed.com/embed?url=${encodeURIComponent(video.url)}`;
  fetch(oembedUrl)
    .then(r => r.json())
    .then(data => {
      if (data.thumbnail_url) {
        video.thumb = data.thumbnail_url;
        video.title = data.title || video.title;
        renderVideoItem(video.id);
        addLog('ok', `ƒê√£ t·∫£i thumbnail: ${video.title.slice(0,40)}...`);
      }
    })
    .catch(() => {
      // Silently fail - network may be blocked
      addLog('warn', `[${video.bvid}] Kh√¥ng th·ªÉ t·∫£i thumbnail qua API (network restricted).`);
    });
}

// ======================== RENDER ========================
function renderVideoList() {
  const wrap = document.getElementById('video-list-wrap');
  if (videoQueue.length === 0) {
    wrap.innerHTML = `<div class="empty-state"><div class="icon">üì≠</div><p>Ch∆∞a c√≥ link n√†o</p><small>Nh·∫≠p link ·ªü tab "NH·∫¨P LINK"</small></div>`;
    return;
  }
  wrap.innerHTML = `
    <div class="video-list-header">
      <span style="width:24px"></span>
      <span style="width:72px">THUMBNAIL</span>
      <span style="flex:1">TH√îNG TIN VIDEO</span>
      <span style="width:160px;text-align:right">THAO T√ÅC</span>
    </div>
    <div class="video-list" id="video-list"></div>
  `;
  const list = document.getElementById('video-list');
  videoQueue.forEach(v => {
    const el = createVideoItemEl(v);
    list.appendChild(el);
  });
  updateStats();
  updateSelectAll();
}

function createVideoItemEl(video) {
  const div = document.createElement('div');
  div.className = `video-item ${video.status === 'done' ? 'done' : video.status === 'error' ? 'error' : video.status === 'loading' ? 'downloading' : ''} ${selectedIds.has(video.id) ? 'selected' : ''}`;
  div.id = `item_${video.id}`;

  const thumbHtml = video.thumb
    ? `<img src="${video.thumb}" alt="thumb" onerror="this.parentElement.innerHTML='üé¨'">`
    : `<span style="color:var(--muted);font-size:13px">${video.platform === 'bilibili' ? 'üì∫' : 'üì±'}</span>`;

  const statusClass = {waiting:'status-waiting',loading:'status-loading',done:'status-done',error:'status-error'}[video.status] || 'status-waiting';
  const statusLabel = {waiting:'CH·ªúT·∫¢I',loading:'ƒêANG T·∫¢I',done:'‚úì XONG',error:'‚úó L·ªñI'}[video.status] || '‚Äî';

  div.innerHTML = `
    <div class="vi-check">
      <label class="checkbox-group" onclick="event.stopPropagation()">
        <input type="checkbox" ${selectedIds.has(video.id) ? 'checked' : ''} onchange="toggleItem('${video.id}', this.checked)">
        <span class="custom-check"></span>
      </label>
    </div>
    <div class="vi-thumb">${thumbHtml}</div>
    <div class="vi-info" onclick="showDetail('${video.id}')" title="Nh·∫•n ƒë·ªÉ xem chi ti·∫øt">
      <div class="vi-title">${escHtml(video.title)}</div>
      <div class="vi-url">${escHtml(video.cleanUrl)}</div>
      <div class="vi-meta">
        <span class="vi-badge ${video.platform === 'bilibili' ? 'badge-bili' : 'badge-dy'}">${video.platform.toUpperCase()}</span>
        <span class="vi-badge badge-type">${video.quality.toUpperCase()}</span>
        ${video.dlThumb ? '<span class="vi-badge" style="background:rgba(0,230,118,0.12);color:var(--success)">üñº ·∫¢NH</span>' : ''}
      </div>
      <div class="progress-bar-wrap"><div class="progress-bar" id="prog_${video.id}" style="width:${video.progress||0}%"></div></div>
    </div>
    <div class="vi-actions">
      <button class="vi-btn video" onclick="event.stopPropagation(); downloadOne('${video.id}', 'video')" ${video.status==='done'?'disabled':''}>‚¨á VIDEO</button>
      <button class="vi-btn image" onclick="event.stopPropagation(); downloadOne('${video.id}', 'thumb')" ${!video.thumb?'disabled':''}>üñº ·∫¢NH</button>
    </div>
    <div class="vi-status ${statusClass}">${statusLabel}</div>
  `;
  return div;
}

function renderVideoItem(id) {
  const video = videoQueue.find(v => v.id === id);
  if (!video) return;
  const el = document.getElementById(`item_${id}`);
  if (!el) return;
  const newEl = createVideoItemEl(video);
  el.replaceWith(newEl);
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ======================== SELECT ========================
function toggleItem(id, checked) {
  if (checked) selectedIds.add(id);
  else selectedIds.delete(id);
  const el = document.getElementById(`item_${id}`);
  if (el) el.classList.toggle('selected', checked);
  updateStats();
  updateSelectAll();
  document.getElementById('btn-download-selected').disabled = selectedIds.size === 0;
}

function toggleSelectAll(cb) {
  const check = document.getElementById('select-all-check');
  if (cb.checked) {
    videoQueue.forEach(v => selectedIds.add(v.id));
  } else {
    selectedIds.clear();
  }
  videoQueue.forEach(v => {
    const el = document.getElementById(`item_${v.id}`);
    if (el) {
      el.classList.toggle('selected', cb.checked);
      const chk = el.querySelector('input[type=checkbox]');
      if (chk) chk.checked = cb.checked;
    }
  });
  updateStats();
  document.getElementById('btn-download-selected').disabled = selectedIds.size === 0;
}

function updateSelectAll() {
  const cb = document.getElementById('select-all');
  const check = document.getElementById('select-all-check');
  if (!cb) return;
  const total = videoQueue.length;
  const sel = selectedIds.size;
  cb.checked = sel === total && total > 0;
  if (check) {
    check.style.background = cb.checked ? 'var(--accent)' : '';
    check.style.borderColor = cb.checked ? 'var(--accent)' : '';
  }
}

// ======================== DOWNLOAD ========================
function getYtDlpCommand(video) {
  const qualityMap = {'best':'bestvideo+bestaudio','1080p':'bestvideo[height<=1080]+bestaudio','720p':'bestvideo[height<=720]+bestaudio','480p':'bestvideo[height<=480]+bestaudio','360p':'bestvideo[height<=360]+bestaudio'};
  const fmtFlag = qualityMap[video.quality] || 'bestvideo+bestaudio';
  const thumbFlag = video.dlThumb ? '--write-thumbnail' : '';
  const mergeFlag = `--merge-output-format ${video.format}`;
  return `yt-dlp -f "${fmtFlag}" ${thumbFlag} ${mergeFlag} -o "%(title)s.%(ext)s" "${video.url}"`;
}

function downloadOne(id, type) {
  const video = videoQueue.find(v => v.id === id);
  if (!video) return;

  if (type === 'thumb' && video.thumb) {
    // Direct image download
    const a = document.createElement('a');
    a.href = video.thumb;
    a.download = (video.bvid || 'thumb') + '.jpg';
    a.target = '_blank';
    a.click();
    addLog('ok', `M·ªü ·∫£nh thumbnail: ${video.title.slice(0,40)}`);
    return;
  }

  // For video: show yt-dlp command and open URL
  const cmd = getYtDlpCommand(video);
  video.status = 'loading';
  video.progress = 10;
  renderVideoItem(id);
  updateStats();

  // Copy command to clipboard
  if (navigator.clipboard) {
    navigator.clipboard.writeText(cmd).then(() => {
      addLog('ok', `ƒê√£ copy l·ªánh yt-dlp. Ch·∫°y trong terminal ƒë·ªÉ t·∫£i!`);
    });
  }

  // Simulate download flow (since we can't actually download in browser without backend)
  addLog('info', `L·ªánh t·∫£i: ${cmd.slice(0,80)}...`);
  showCommandModal(video, cmd);

  // Mark as "done" after showing command
  setTimeout(() => {
    video.status = 'done';
    video.progress = 100;
    renderVideoItem(id);
    updateStats();
    addLog('ok', `[${video.platform.toUpperCase()}] ${video.title.slice(0,40)} ‚Äî L·ªánh ƒë√£ s·∫µn s√†ng.`);
  }, 800);
}

function downloadSelected() {
  const ids = [...selectedIds];
  if (ids.length === 0) return;
  addLog('info', `B·∫Øt ƒë·∫ßu t·∫£i ${ids.length} video ƒë√£ ch·ªçn...`);

  const cmds = ids.map(id => {
    const v = videoQueue.find(x => x.id === id);
    return v ? getYtDlpCommand(v) : null;
  }).filter(Boolean);

  // Show batch command modal
  showBatchCommandModal(cmds, ids.length);

  ids.forEach((id, i) => {
    setTimeout(() => {
      const v = videoQueue.find(x => x.id === id);
      if (v) { v.status = 'done'; renderVideoItem(id); updateStats(); }
    }, i * 200);
  });
}

function downloadAll() {
  const cmds = videoQueue.map(v => getYtDlpCommand(v));
  showBatchCommandModal(cmds, videoQueue.length);
  videoQueue.forEach((v, i) => {
    setTimeout(() => { v.status = 'done'; renderVideoItem(v.id); updateStats(); }, i * 150);
  });
  addLog('info', `T·∫°o l·ªánh t·∫£i cho t·∫•t c·∫£ ${videoQueue.length} video.`);
}

// ======================== COMMAND MODALS ========================
function showCommandModal(video, cmd) {
  document.getElementById('modal-title').textContent = 'üìã L·ªÜNH T·∫¢I VIDEO';
  const thumbEl = document.getElementById('modal-thumb');
  if (video.thumb) { thumbEl.src = video.thumb; thumbEl.style.display = ''; }
  else thumbEl.style.display = 'none';

  document.getElementById('modal-info').innerHTML = `
    <strong>T√™n:</strong> ${escHtml(video.title)}<br>
    <strong>Platform:</strong> ${video.platform.toUpperCase()}<br>
    <strong>Ch·∫•t l∆∞·ª£ng:</strong> ${video.quality}<br>
    <strong>URL:</strong> <a href="${video.url}" target="_blank" style="color:var(--accent);word-break:break-all">${escHtml(video.url)}</a><br>
    <br>
    <strong>L·ªánh yt-dlp:</strong>
    <code style="display:block;background:var(--bg);padding:10px;border-radius:5px;margin:6px 0;font-size:10px;color:var(--success);border:1px solid var(--border);word-break:break-all;white-space:pre-wrap">${escHtml(cmd)}</code>
    <small style="color:var(--muted)">L·ªánh ƒë√£ ƒë∆∞·ª£c copy v√†o clipboard. D√°n v√†o terminal ƒë·ªÉ t·∫£i.</small>
  `;
  document.getElementById('modal-actions').innerHTML = `
    <button class="btn btn-primary" onclick="navigator.clipboard.writeText('${escHtml(cmd).replace(/'/g,"\\'")}'); addLog('ok','ƒê√£ copy l·ªánh!')">üìã Copy l·ªánh</button>
    <a href="${video.url}" target="_blank"><button class="btn btn-secondary">üîó M·ªü link</button></a>
    <button class="btn btn-secondary" onclick="closeModal()">ƒê√≥ng</button>
  `;
  document.getElementById('detail-modal').classList.add('open');
}

function showBatchCommandModal(cmds, count) {
  document.getElementById('modal-title').textContent = `üì¶ L·ªÜNH T·∫¢I H√ÄNG LO·∫†T (${count} video)`;
  document.getElementById('modal-thumb').style.display = 'none';
  const allCmds = cmds.join('\n');
  document.getElementById('modal-info').innerHTML = `
    <strong>T·ªïng c·ªông ${count} l·ªánh:</strong><br>
    <code style="display:block;background:var(--bg);padding:10px;border-radius:5px;margin:8px 0;font-size:9px;color:var(--success);border:1px solid var(--border);word-break:break-all;white-space:pre-wrap;max-height:200px;overflow-y:auto">${escHtml(allCmds)}</code>
    <small style="color:var(--muted)">Ho·∫∑c t·∫°o file links.txt v√† d√πng: <code style="color:var(--accent)">yt-dlp -a links.txt -f "bestvideo+bestaudio" --write-thumbnail -o "%(title)s.%(ext)s"</code></small>
  `;
  const urlsOnly = videoQueue.filter(v => selectedIds.has(v.id) || count === videoQueue.length).map(v=>v.url).join('\n');
  document.getElementById('modal-actions').innerHTML = `
    <button class="btn btn-primary" onclick="navigator.clipboard.writeText(${JSON.stringify(allCmds)}); addLog('ok','ƒê√£ copy t·∫•t c·∫£ l·ªánh!')">üìã Copy t·∫•t c·∫£ l·ªánh</button>
    <button class="btn btn-secondary" onclick="navigator.clipboard.writeText(${JSON.stringify(urlsOnly)}); addLog('ok','ƒê√£ copy URLs!')">üîó Copy ch·ªâ URLs</button>
    <button class="btn btn-secondary" onclick="closeModal()">ƒê√≥ng</button>
  `;
  document.getElementById('detail-modal').classList.add('open');
}

// ======================== DETAIL MODAL ========================
function showDetail(id) {
  const video = videoQueue.find(v => v.id === id);
  if (!video) return;
  document.getElementById('modal-title').textContent = 'üìπ CHI TI·∫æT VIDEO';
  const thumbEl = document.getElementById('modal-thumb');
  if (video.thumb) { thumbEl.src = video.thumb; thumbEl.style.display = 'block'; }
  else thumbEl.style.display = 'none';
  document.getElementById('modal-info').innerHTML = `
    <strong>T√™n:</strong> ${escHtml(video.title)}<br>
    <strong>Platform:</strong> ${video.platform.toUpperCase()}<br>
    <strong>BVID/ID:</strong> ${video.bvid || '‚Äî'}<br>
    <strong>Ch·∫•t l∆∞·ª£ng:</strong> ${video.quality} | <strong>Format:</strong> ${video.format}<br>
    <strong>T·∫£i thumbnail:</strong> ${video.dlThumb ? 'C√≥' : 'Kh√¥ng'}<br>
    <strong>URL:</strong><br>
    <a href="${video.url}" target="_blank" style="color:var(--accent);word-break:break-all;font-size:11px">${escHtml(video.url)}</a>
  `;
  const cmd = getYtDlpCommand(video);
  document.getElementById('modal-actions').innerHTML = `
    <button class="btn btn-primary" onclick="downloadOne('${id}','video');closeModal()">‚¨á T·∫¢I VIDEO</button>
    ${video.thumb ? `<button class="btn btn-secondary" onclick="downloadOne('${id}','thumb');closeModal()">üñº T·∫¢I ·∫¢NH</button>` : ''}
    <button class="btn btn-secondary" onclick="navigator.clipboard.writeText(${JSON.stringify(cmd)});addLog('ok','ƒê√£ copy l·ªánh!')">üìã Copy l·ªánh</button>
    <button class="btn btn-secondary" onclick="closeModal()">ƒê√≥ng</button>
  `;
  document.getElementById('detail-modal').classList.add('open');
}

function closeModal() {
  document.getElementById('detail-modal').classList.remove('open');
}

// ======================== UTILITIES ========================
function clearQueue() {
  videoQueue = [];
  selectedIds.clear();
  renderVideoList();
  addLog('warn', 'ƒê√£ x√≥a to√†n b·ªô h√†ng ƒë·ª£i.');
}

function clearInput() {
  document.getElementById('link-input').value = '';
}

function updateStats() {
  const total = videoQueue.length;
  const done = videoQueue.filter(v => v.status === 'done').length;
  const errors = videoQueue.filter(v => v.status === 'error').length;
  document.getElementById('stat-total').textContent = total;
  document.getElementById('stat-selected').textContent = selectedIds.size;
  document.getElementById('stat-done').textContent = done;
  document.getElementById('stat-error').textContent = errors;
  document.getElementById('queue-count').textContent = total;
}

function addLog(type, msg) {
  const log = document.getElementById('log-area');
  if (!log) return;
  const time = new Date().toLocaleTimeString('vi-VN');
  const div = document.createElement('div');
  div.className = `log-line log-${type}`;
  div.textContent = `[${time}] ${msg}`;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

function switchTab(name) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  const tabs = ['input','queue','guide'];
  document.querySelectorAll('.tab')[tabs.indexOf(name)].classList.add('active');
}

// Close modal on overlay click
document.getElementById('detail-modal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

// Handle select-all checkbox visual
document.getElementById('select-all').addEventListener('change', function() {
  const check = document.getElementById('select-all-check');
  if (this.checked) {
    check.style.background = 'var(--accent)'; check.style.borderColor = 'var(--accent)';
    check.innerHTML = '<span style="font-size:10px;color:var(--bg)">‚úì</span>';
  } else {
    check.style.background = ''; check.style.borderColor = ''; check.innerHTML = '';
  }
});
</script>
</body>
</html>
